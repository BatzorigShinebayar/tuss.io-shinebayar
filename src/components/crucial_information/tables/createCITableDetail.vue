<template>  <div class="row-detail">    <table class="stage-detail table-bordered">      <tbody>        <div          v-for="(stageGRP, index) in taskStageGrp"          :key="index + '_' + stageGRP.code"          :class="{ 'hidden-task-stageGroup': stageGRP.state === 'stage_hide' }"          class="w-100"        >          <tr>            <td>              {{ stageGRP.code }}            </td>            <td class="w-100">              {{ stageGRP.name }}            </td>            <td style="min-width: 160px; width: 160px">              Due: {{ stageGRP.end_date }}            </td>            <td style="width: 150px">              <b-progress                class="stage-progress"                :max="stageGRP.progress.maxPorgress"                show-value              >                <b-progress-bar                  :value="stageGRP.progress.complete"                  variant="success"                ></b-progress-bar>                <b-progress-bar                  :value="stageGRP.progress.onProcess"                  variant="warning"                ></b-progress-bar>                <b-progress-bar                  :value="stageGRP.progress.onQueue"                  variant="danger"                ></b-progress-bar>              </b-progress>            </td>            <td>              <router-link                v-if="stageGRP.entry"                :to="{                  name: 'form-edit',                  query: {                    id: stageGRP.form,                    did: stageGRP.entry,                    tsk: stageGRP.task_id,                    tsg: stageGRP.taskStageGRP_id,                  },                }"                class="btn btn-secondary newTab"                target="_blank"                >Perform task</router-link              >              <router-link                v-else                :to="{                  name: 'form-entry',                  query: {                    id: stageGRP.form,                    tal: algorithm,                    tsk: stageGRP.task_id,                    tsg: stageGRP.taskStageGRP_id,                  },                }"                class="btn btn-secondary newTab"                target="_blank"                >Perform task</router-link              >            </td>            <td v-if="!hide" style="width: 25px; height: 25px">              <i                class="bx bxs-chevron-down-circle task-detail-icon"                @click="showTaskStageDetail(index)"              ></i>            </td>          </tr>          <tr v-if="stageGRP.showStages">            <td colspan="6">              <table                class="stage-detail sm"                style="background-color: transparent"              >                <tr                  v-for="(stage, indx) in stageGRP.stage"                  :key="stage.code + '_' + indx"                  :style="[                    hide === true && !stage.plan_time                      ? { display: 'none' }                      : {},                  ]"                >                  <td style="width: 150px">{{ stage.code }}</td>                  <td>{{ stage.name }}</td>                  <td style="width: 26px">                    <div class="d-flex">                      <img                        :id="                          'tooltip_img_' +                          stage.task_stage_group_id +                          '_' +                          stage.task_stage_id                        "                        :src="stage.employee_id | get_employee_pict"                        onError="this.onerror=null;this.src='/tusd_images/profile/human_icon.png';"                        class="rounded-circle con-vs-avatar align-self-center"                        style="width: 25px"                        v-b-tooltip.hover                      />                      <b-tooltip                        :target="                          'tooltip_img_' +                          stage.task_stage_group_id +                          '_' +                          stage.task_stage_id                        "                        >{{ stage.employeeName }}</b-tooltip                      >                    </div>                  </td>                  <td style="width: 80px">                    <b-badge v-if="stage.state === 'on_queue'" variant="danger"                      >On queue                    </b-badge>                    <b-badge                      v-else-if="stage.state === 'on_process'"                      variant="warning"                      >On process                    </b-badge>                    <b-badge                      v-else-if="stage.state === 'complete'"                      variant="success"                      >Completed                    </b-badge>                  </td>                  <td style="width: 50px">                    <div class="d-inline">                      <b-input-group size="sm" style="width: 85px">                        <b-input-group-prepend class="m-0">                          <b-button class="plan-time">                            <i                              class="bx bxs-time-five align-middle"                              variant="dark"                            ></i>                          </b-button>                        </b-input-group-prepend>                        <b-form-input                          v-model="stage.plan_time"                          class="plan-time"                          size="sm"                          placeholder="00:00"                          type="text"                          :class="{                            warning:                              stage.is_due === true &&                              !stage.plan_time &&                              stage.employee === parseInt($route.params.id),                          }"                          :required="stage.is_due === true"                          :disabled="hide === true"                          @change="planTime(stage)"                        ></b-form-input>                      </b-input-group>                    </div>                  </td>                </tr>              </table>            </td>          </tr>        </div>      </tbody>    </table>  </div></template><script>export default {  name: 'CreateCI04TableDetail',  props: {    rowData: {      type: Object,      required: true,    },    plannedTask: {      type: Object,      default() {        return {};      },    },    hide: {      type: Boolean,      default() {        return false;      },    },    detailView: {      type: Boolean,      default() {        return false;      },    },    executingEmployee: {      type: Number,      default: 0,    },    algorithm: {      type: Number,      default: null,    },  },  data() {    return {      planningData: [],      plan_week_year: '',      plan_week_number: 0,      totalPlanHour: '',      taskStageGrp: [],    };  },  mounted() {    this.taskStageGrp = this.rowData.task_stage_groups;    const algorithms = this.$store.getters.company.algorithm;    if (this.detailView) {      for (const i in this.taskStageGrp) {        this.taskStageGrp[i].showStages = true;      }    }    for (const i in this.taskStageGrp) {      const entry = this.taskStageGrp[i].entry;      if (entry === null || entry === 'null' || entry === undefined) {        delete this.taskStageGrp[i].entry;      }      const form = this.taskStageGrp[i].form;      if (form === null || form === 'null' || form === undefined) {        for (const j in algorithms) {          for (const l in algorithms[j].stage_groups) {            if (              algorithms[j].stage_groups[l].id ===              this.taskStageGrp[i].stageGroup_id            ) {              this.taskStageGrp[i].form = parseInt(                algorithms[j].stage_groups[l].form              );            }          }        }      }      for (const j in this.taskStageGrp[i].stage) {        if (this.taskStageGrp[i].stage[j].plan_time) {          this.planTime(this.taskStageGrp[i].stage[j], true);        }      }    }    this.checkDueStage();  },  beforeMount() {    const weekId = this.$route.params.weekId;    const splitList = weekId.split('-');    const weekYear = parseInt(splitList[0]);    const weekNumber = parseInt(splitList[1]);    if (weekNumber === 53) {      this.plan_week_number = 1;      this.plan_week_year = weekYear + 1;    } else {      this.plan_week_year = weekYear;      this.plan_week_number = weekNumber + 1;    }    if (this.plannedTask.json_data !== null) {      this.planningData = this.plannedTask.json_data.planned_tasks;      this.$store.state['nextWeekPlanData'] = this.planningData;    }  },  methods: {    checkDueStage() {      const taskStageGrp = this.taskStageGrp;      for (const i in taskStageGrp) {        for (const j in taskStageGrp[i].stage) {          if (            taskStageGrp[i].stage[j].is_due &&            !taskStageGrp[i].stage[j].plan_time &&            this.executingEmployee === parseInt(this.$route.params.id)          ) {            taskStageGrp[i].showStages = true;          }        }      }    },    showTaskStageDetail(index) {      /* eslint-disable vue/no-mutating-props */      this.rowData.task_stage_groups[index].showStages =        !this.rowData.task_stage_groups[index].showStages;      event.target.classList.toggle('active');    },    isNumber(evt) {      evt = evt || window.event;      return /^-?\d+$/.test(evt);    },    planTime(data, auto = false) {      const nextWeekPlanDataDummy = this.$store.state['nextWeekPlanData'];      // console.log('nextWeekPlanDataDummy', nextWeekPlanDataDummy);      if (nextWeekPlanDataDummy !== undefined) {        this.planningData = nextWeekPlanDataDummy;      }      let check = true;      const time = data.plan_time;      if (!auto) {        // let indx;        // let checkNum = true;        // for (indx = 5; indx <= time.length + 1; indx++) {        //   if (!this.isNumber(time.charAt(indx))) {        //     checkNum = false;        //   }        // }        const splitTime = time.split(':');        if (          splitTime.length > 0 &&          this.isNumber(splitTime[0]) &&          this.isNumber(splitTime[1])        ) {          event.target.classList.remove('warning');          event.target.classList.add('success');          check = true;        } else if (time === '00:00') {          event.target.classList.remove('warning');          event.target.classList.remove('success');        } else {          event.target.classList.remove('success');          event.target.classList.add('warning');          check = false;        }      }      let dueStageCount = 0;      if (check) {        const jsonData = {};        // jsonData = data;        jsonData.start_date = data.start_date;        if (data.employee_id === parseInt(this.$route.params.id)) {          jsonData.is_assigned = true;        } else {          jsonData.is_assigned = false;        }        jsonData.plan_week_number = this.plan_week_number;        jsonData.stage = data.stage_id;        jsonData.is_due = data.is_due;        jsonData.state = data.state;        jsonData.task_stage_group = data.task_stage_group_id;        jsonData.task_stage = data.task_stage_id;        jsonData.end_date = data.end_date;        jsonData.organization = this.$store.getters.activeCompany;        jsonData.form = data.form_id;        jsonData.employee = data.employee_id;        const splicedList = time.split(':');        let intPlanHour = parseInt(splicedList[0]);        let intPlanMin = parseInt(splicedList[1]);        if (intPlanMin >= 60) {          const min = Math.floor(intPlanMin / 60);          intPlanMin = intPlanMin - 60 * min;          intPlanHour += min;        }        if (!intPlanHour.toString().charAt(1)) {          intPlanHour = '0' + intPlanHour;        }        if (!intPlanMin.toString().charAt(1)) {          intPlanMin = '0' + intPlanMin;        }        data.plan_time = intPlanHour + ':' + intPlanMin;        jsonData.plan_hour = intPlanHour + ':' + intPlanMin;        jsonData.plan_week_year = this.plan_week_year;        jsonData.department = data.department_id;        jsonData.stage_group = data.stage_group_id;        jsonData.task = data.task_id;        jsonData.algorithm = data.algorithm;        jsonData.entry = data.entry_id;        if (this.planningData.length === 0) {          this.planningData.push(jsonData);        } else {          let checkStage = false;          for (const j in this.planningData) {            if (this.planningData[j].task_stage === jsonData.task_stage) {              this.planningData[j].plan_hour = intPlanHour + ':' + intPlanMin;              checkStage = true;            }          }          if (!checkStage) {            this.planningData.push(jsonData);          }        }      }      for (const j in this.planningData) {        if (this.planningData[j].plan_hour === '00:00') {          this.planningData.splice(j, 1);        }      }      this.$store.state['nextWeekPlanData'] = this.planningData;      // console.log('planningData', this.$store.state['nextWeekPlanData']);      // this.$store.dispatch('nextWeekPlanData', this.planningData);      // console.log('after plan', this.$store.state['nextWeekPlanData']);      const dashboardJson = {};      const dashboardList = [];      const planningTasks = [];      let totalHour = 0;      let totalMin = 0;      for (const j in this.planningData) {        if (this.planningData[j].is_due && this.planningData[j].is_assigned) {          dueStageCount += 1;        }        const taskId = this.planningData[j].task;        const planHour = this.planningData[j].plan_hour;        const splicedList = planHour.split(':');        const intPlanHour = parseInt(splicedList[0]);        const intPlanMin = parseInt(splicedList[1]);        const jsonData = {};        jsonData.taskId = taskId;        jsonData.totalHour = intPlanHour;        jsonData.totalMin = intPlanMin;        dashboardList.push(jsonData);        if (!planningTasks.includes(this.planningData[j].task)) {          planningTasks.push(this.planningData[j].task);        }        totalHour += intPlanHour;        totalMin += intPlanMin;        if (totalMin >= 60) {          const min = Math.floor(totalMin / 60);          totalMin = totalMin - 60 * min;          totalHour += min;        }      }      const dashboardData = [];      for (const i in planningTasks) {        dashboardData.push({ taskId: 0, totalHour: 0, totalMin: 0 });        for (const j in dashboardList) {          if (dashboardList[j].taskId === planningTasks[i]) {            dashboardData[i].taskId = planningTasks[i];            dashboardData[i].totalHour += dashboardList[j].totalHour;            dashboardData[i].totalMin += dashboardList[j].totalMin;            if (dashboardData[i].totalMin >= 60) {              const min = Math.floor(dashboardData[i].totalMin / 60);              dashboardData[i].totalMin = dashboardData[i].totalMin - 60 * min;              dashboardData[i].totalHour += min;            }          }        }      }      if (!totalHour.toString().charAt(1)) {        totalHour = '0' + totalHour;      }      if (!totalMin.toString().charAt(1)) {        totalMin = '0' + totalMin;      }      dashboardJson.plannedTask = dashboardData;      dashboardJson.dueStageCount = dueStageCount;      dashboardJson.total_hour = totalHour + ':' + totalMin;      this.$emit('emit_data', dashboardJson);    },  },};</script><style scoped>.stage-progress {  width: 200px;}.hidden-task-stageGroup {  display: none;}.plan-time {  border: 0;  background-color: #f8f8fb;  color: #495057;  font-size: 14px;  line-height: 16px;}.plan-time.warning {  border: 1px solid red !important;}.plan-time.success {  border: 1px solid green !important;}.newTab {  background-color: #2a3042;  min-width: 153px;  width: 153px;  color: white;}</style>