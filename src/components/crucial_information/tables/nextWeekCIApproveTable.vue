<template>  <div>    <b-table striped hover :fields="tableFields" :items="crusialInformations">      <template #head(checkbox)>        <div class="d-flex">          <b-form-checkbox            v-model="isCheckedAll"            class="mx-auto"            :value="true"            @change="toggleAll"          />        </div>      </template>      <template #cell(checkbox)="props">        <div class="d-flex">          <b-form-checkbox            v-model="props.item.is_checked"            :value="true"            class="mx-auto"            @change="checked(props.item)"          />        </div>      </template>      <template #cell(dropdown)="props">        <i          :id="props.item"          class="dropdown bx bxs-chevron-down-circle task-detail-icon"          :class="{ active: props.detailsShowing === true }"          @click="toggleDetails(props)"        ></i>      </template>      <template #cell(employee)="props">        <router-link          :to="{            name: 'crucialInfo04',            params: {              weekId: $route.params.weekId,              type: 'employee',              id: props.item.employee_id,            },            query: {              tab: 'nextWeek',            },          }"          class="task-link"        >          {{ props.item.employee }}        </router-link>      </template>      <template #cell(state)="props" class="d-inline">        <div          v-if="props.item.state === 'confirm'"          class="state text-white bg-success"          style="width: 85px"        >          Confirmed        </div>        <div          v-else-if="props.item.state === 'sent'"          class="state bg-warning"          style="width: 80px"        >          Checking        </div>        <div v-else class="state text-white bg-danger" style="width: 75px">          Not sent        </div>      </template>      <template #cell(action)="props" class="d-inline">        <b-dropdown          v-if="            props.item.state === 'sent' &&            isMyAch(props.item.employee_id) &&            canConfirm &&            canReject          "          text="Action"          variant="dark"          class="mx-3"        >          <b-dropdown-item            v-if="canConfirm"            @click="confirmCI(props.item.id, props.index)"            :disabled="confirmDisable"            >Confirm</b-dropdown-item          >          <b-dropdown-item            v-if="canReject"            v-b-modal.reject-CI            @click="rejectModal(props.item)"            >Reject</b-dropdown-item          >        </b-dropdown>      </template>      <template #cell(send_date)="props" class="d-inline">        {{ props.item.sent_date | datetime }}      </template>      <template #cell(confirm_date)="props" class="d-inline">        {{ props.item.confirmed_date | datetime }}      </template>      <template #row-details="props">        <TableDetail :row-data="props.item.tasks" />      </template>    </b-table>    <b-modal id="reject-CI" ref="reject-CI" title="Rejecting reason">      <b-col class="d-flex mb-2" cols="12">        <p class="modal-text mr-2">Department:</p>        <b class="modal-text">{{ modalData.department }}</b>      </b-col>      <b-col class="d-flex mb-2" cols="12">        <p class="modal-text mr-2">Employee:</p>        <b class="modal-text">{{ modalData.employee }}</b>      </b-col>      <b-col class="d-flex mb-2" cols="12">        <p class="modal-text mr-2">Date:</p>        <b class="modal-text">{{ modalData.date }}</b>      </b-col>      <b-col cols="12">        <p class="modal-text">Reason:</p>        <b-form-textarea          v-model="modalData.reason"          placeholder="Write reason why you rejecting"        ></b-form-textarea>        <p id="reason_warning" class="text-danger" style="display: none">          Please write reason why you rejecting        </p>      </b-col>      <template #modal-footer="{ cancel }">        <div class="w-100">          <b-button            variant="dark"            class="ml-2 float-right"            :disabled="modalReject"            @click="rejectCI"          >            Submit          </b-button>          <b-button class="float-right" @click="cancel()"> Cancel </b-button>        </div>      </template>    </b-modal>  </div></template><script>import TableDetail from '@/components/crucial_information/tables/NextWeekCIApproveTableDetail';export default {  name: 'NextWeekCIApproveTable',  components: { TableDetail },  props: {    tableData: {      type: [Array, Object],      default() {        return [];      },    },    detailView: {      type: Boolean,      default() {        return false;      },    },  },  data() {    return {      perPage: 5,      tableFields: [        {          key: 'checkbox',          label: '',        },        {          key: 'dropdown',          label: '',        },        {          key: 'employee',          label: 'Employee',          sortable: true,        },        {          key: 'total_planned_hour',          label: 'Total Planned Hours',        },        {          key: 'planned_tasks',          label: 'Planned Tasks',        },        {          key: 'planned_stages',          label: 'Planned Stages',        },        {          key: 'send_date',          label: 'Sent date',        },        {          key: 'confirm_date',          label: 'Confirmed date',        },        {          key: 'state',          label: 'State',          sortable: true,        },        {          key: 'action',          label: '',        },      ],      tableDatas: null,      crusialInformations: [],      tasks: [],      isCheckedAll: false,      checkedList: [],      modalData: {        department: null,        employee: null,        date: null,        reason: null,        id: null,        index: null,      },      canConfirm: false,      canReject: false,      isHM1: false,      confirmDisable: false,      modalReject: false,    };  },  watch: {    detailView() {      this.showAllTaskDetail();    },    tableData(data) {      this.crusialInformations = [];      const employees = this.$store.getters.company.employees;      const alltaskList = [];      const nextWeekPlans = data;      for (const i in nextWeekPlans) {        const tableDataJson = {};        for (const j in employees) {          if (employees[j].partner__id === nextWeekPlans[i].employee) {            tableDataJson.employee =              employees[j].partner__last_name +              ' ' +              employees[j].partner__name;            tableDataJson.employee_id = employees[j].partner__id;            tableDataJson.department = employees[j].department__name;          }        }        tableDataJson.total_planned_hour = nextWeekPlans[i].total_work_hour;        tableDataJson.confirmed_date = nextWeekPlans[i].confirmed_date;        tableDataJson.sent_date = nextWeekPlans[i].sent_date;        if (nextWeekPlans[i].json_data === null) {          tableDataJson.planned_tasks = 0;          tableDataJson.planned_stages = 0;          tableDataJson.state = 'draft';        } else {          const jsonData = nextWeekPlans[i].json_data;          const plannedStages = jsonData.planned_tasks;          tableDataJson.planned_stages = plannedStages.length;          tableDataJson.state = nextWeekPlans[i].state;          const taskList = [];          const taskData = [];          for (const l in plannedStages) {            if (!taskList.includes(plannedStages[l].task)) {              taskList.push(plannedStages[l].task);              taskData.push({ id: plannedStages[l].task, stages: [] });            }            if (!alltaskList.includes(plannedStages[l].task)) {              alltaskList.push(plannedStages[l].task);            }          }          for (const a in taskData) {            for (const b in plannedStages) {              if (taskData[a].id === plannedStages[b].task) {                taskData[a].stages.push(plannedStages[b]);              }            }          }          tableDataJson.planned_tasks = taskList.length;          tableDataJson.tasks = taskData;          tableDataJson.taskList = taskList;          tableDataJson.stages = plannedStages;          tableDataJson.id = nextWeekPlans[i].id;          tableDataJson.is_checked = false;          tableDataJson.date =            nextWeekPlans[i].plan_start_date +            ' to ' +            nextWeekPlans[i].plan_end_date;        }        this.crusialInformations.push(tableDataJson);      }      this.getTaskInfoByIds({ ids: alltaskList });    },    tasks(data) {      for (const i in this.crusialInformations) {        for (const j in data) {          for (const l in this.crusialInformations[i].tasks) {            if (this.crusialInformations[i].tasks[l].id === data[j].id) {              this.crusialInformations[i].tasks[l].code = data[j].code;              this.crusialInformations[i].tasks[l].end_date = data[j].end_date;              this.crusialInformations[i].tasks[l].start_date =                data[j].start_date;              this.crusialInformations[i].tasks[l].name = data[j].name;              let onProcess = 0;              let complete = 0;              let onQueue = 0;              const stages = this.crusialInformations[i].tasks[l].stages;              for (const m in stages) {                const algorithm = this.$store.getters.company.algorithm;                for (const n in algorithm) {                  if (algorithm[n].id === stages[m].algorithm) {                    for (const o in algorithm[n].stage_groups) {                      if (                        algorithm[n].stage_groups[o].id ===                        stages[m].stage_group                      ) {                        for (const p in algorithm[n].stage_groups[o].stages) {                          if (                            algorithm[n].stage_groups[o].stages[p].id ===                            stages[m].stage                          ) {                            for (const j in this.crusialInformations[i].tasks) {                              if (                                this.crusialInformations[i].tasks[j].id ===                                stages[m].task                              ) {                                const stage = {};                                const algStage =                                  algorithm[n].stage_groups[o].stages[p];                                stage.code = algStage.code;                                stage.name = algStage.name;                                if (stages[m].state === 'on_process') {                                  onProcess += 1;                                } else if (stages[m].state === 'complete') {                                  complete += 1;                                } else if (stages[m].state === 'on_queue') {                                  onQueue += 1;                                }                                stage.plan_time = stages[m].plan_hour;                                stage.state = stages[m].state;                                stages[m] = stage;                              }                            }                          }                        }                      }                    }                  }                }              }              this.crusialInformations[i].tasks[l].stages = stages;              const max = onProcess + complete + onQueue;              this.crusialInformations[i].tasks[l].progress = {                onProcess,                complete,                onQueue,                max,              };            }          }        }      }    },    checkedList(data) {      if (data.length !== 0) {        this.$emit('checked_criticalInfo', data);      }    },  },  beforeMount() {    const departments = this.$store.getters.company.department;    if (this.permission('ach1_hm1')) {      this.canConfirm = true;      this.canReject = true;      this.isHM1 = true;    } else if (this.$route.params.type === 'department') {      for (const i in departments) {        if (          departments[i].id === parseInt(this.$route.params.id) &&          departments[i].manager__id === this.$store.getters.user.partner_id        ) {          if (this.permission('ach1_hm2')) {            this.canConfirm = true;            this.canReject = true;          }        }      }    }  },  methods: {    isMyAch(data) {      if (!this.isHM1) {        if (data !== this.$store.getters.user.partner_id) {          return true;        } else {          return false;        }      } else {        return true;      }    },    async getTaskInfoByIds(param) {      const response = await this.$store.dispatch('getTaskInfoByIds', param);      if (response.status === 200) {        this.tasks = response.data.return_data;      }    },    toggleDetails(rowData) {      this.$set(        this.crusialInformations[rowData.index],        '_showDetails',        !this.crusialInformations[rowData.index]._showDetails      );    },    showAllTaskDetail() {      for (const i in this.crusialInformations) {        this.toggleClass(this.crusialInformations[i].task_id);        this.$set(this.crusialInformations[i], '_showDetails', this.detailView);      }    },    async toggleClass(data) {      await document.getElementById(data).classList.toggle('active');    },    async updateNextWeekPlan(param, index) {      const response = await this.$store.dispatch('updateNextWeekPlan', param);      if (response.status === 200 && response.data.result) {        this.confirmDisable = false;        this.modalReject = false;        this.crusialInformations[index].state = param.data.state;      }    },    rejectModal(data) {      this.modalData.department = data.department;      this.modalData.employee = data.employee;      this.modalData.date = data.date;      this.modalData.id = data.id;      this.modalData.index = data.index;    },    updateCIData(id, index, state) {      const urlParam = {};      let jsonData = {};      urlParam.urlParam = id + '/';      for (const i in this.tableData) {        if (this.tableData[i].id === id) {          jsonData = this.tableData[i].json_data;          jsonData.state = state;          if (state === 'draft') {            jsonData.desciption = this.modalData.reason;            this.modalData.reason = null;          }        }      }      urlParam.data = jsonData;      this.updateNextWeekPlan(urlParam, index);    },    rejectCI() {      this.modalReject = true;      if (this.modalData.reason !== null) {        document.getElementById('reason_warning').style.display = 'none';        const id = this.modalData.id;        const index = this.modalData.index;        this.updateCIData(id, index, 'draft');        this.$refs['reject-CI'].hide();      } else {        document.getElementById('reason_warning').style.display = 'block';      }    },    confirmCI(id, index) {      this.confirmDisable = true;      this.updateCIData(id, index, 'confirm');    },    toggleAll() {      for (const i in this.crusialInformations) {        if (this.crusialInformations[i].state === 'sent') {          this.crusialInformations[i].is_checked = this.isCheckedAll;          if (this.isCheckedAll) {            this.checkedList.push(this.crusialInformations[i].id);          } else {            this.checkedList = [];          }        }      }    },    checked(data) {      if (data.is_checked && data.state === 'sent') {        this.checkedList.push(data.id);      } else {        const index = this.checkedList.indexOf(data.id);        if (index > -1) {          this.checkedList.splice(index, 1);        }      }    },  },};</script><style scoped>.state {  text-align: center;  border-radius: 50px;}.action {  background: #1f304a;  border-radius: 4px;  color: white;}</style>