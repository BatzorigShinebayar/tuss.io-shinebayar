<template>  <b-form class="d-block mt-3 overflow-auto">    <div      v-for="(k, i) in systemProblem"      :key="'system_' + i"      class="overflow-visible"    >      <div class="mb-2">        <b-col cols="12">          <div class="flex-space-between">            <p class="number mr-2">{{ i + 1 }}</p>            <div class="hl align-self-center"></div>          </div>        </b-col>      </div>      <div>        <b-col cols="12">          <b-form-group            label="Choose conflict type"            :label-for="'systemConflictType_' + i"          >            <treeselect              :id="'systemConflictType_' + i"              v-model="k.conflict_type"              placeholder="- Choose -"              :multiple="false"              :options="system_conflict_types"              :clearable="false"            />          </b-form-group>        </b-col>      </div>      <div v-if="k.regulation">        <b-row class="mx-1">          <b-col cols="6">            <b-form-group              label="Regulations"              :label-for="'systemRegulations_' + i"            >              <treeselect                :id="'systemRegulations_' + i"                v-model="k.regulation"                placeholder="- Choose -"                :multiple="false"                :options="system_regulations"                :clearable="false"              />            </b-form-group>          </b-col>          <b-col cols="6">            <b-form-group              label="Regulation duty"              :label-for="'systemDuty_' + i"            >              <treeselect                :id="'systemDuty_' + i"                v-model="k.duty"                placeholder="- Choose -"                :multiple="false"                :options="system_duty"                :clearable="false"              />            </b-form-group>          </b-col>        </b-row>      </div>      <div v-if="k.reason">        <b-col cols="12">          <b-form-group            label="Insert conflict reason"            :label-for="'systemReason_' + i"          >            <b-form-input              :id="'systemReason_' + i"              v-model="k.reason"              type="text"              disabled              :value="k.reason"              name="name"            ></b-form-input>          </b-form-group>        </b-col>      </div>      <div v-if="k.suggestion">        <b-col cols="12">          <b-form-group            label="Insert suggestion for conflict"            :label-for="'systemSuggest_' + i"          >            <b-form-input              :id="'systemSuggest_' + i"              v-model="k.suggestion"              type="text"              disabled              name="name"            ></b-form-input>          </b-form-group>        </b-col>      </div>      <div v-if="k.task">        <b-col cols="12">          <b-form-group label="Is task related?">            <b-form-checkbox              v-model="k.isSelected"              switch              disabled              class="mr-n2"              @input="isChecked(k)"            >              <span class="sr-only">Switch for previous text input</span>            </b-form-checkbox>          </b-form-group>        </b-col>      </div>      <div v-if="k.isSelected === true">        <b-col cols="12">          <b-form-group            label="Choose related task"            :label-for="'systemTask_' + i"          >            <treeselect              :id="'systemTask_' + i"              v-model="k.task"              placeholder="- Choose -"              :multiple="false"              :options="system_task"              :clearable="false"            />          </b-form-group>        </b-col>      </div>      <div v-if="k.isSelected === true && k.task_stage">        <b-col cols="12">          <b-form-group            label="Choose related task's stage"            :label-for="'systemTaskDetail_' + i"          >            <treeselect              :id="'systemTaskDetail_' + i"              v-model="k.task_stage"              :options="task_stage"              placeholder="- choose -"              :disable-branch-nodes="true"              :show-count="true"            ></treeselect>          </b-form-group>        </b-col>      </div>      <div>        <b-col cols="12">          <b-form-group            v-if="dailyCheckCreateJson.diagnose_types"            label="Choose diagnoses for conflict"            :label-for="'systemDiagnose_' + i"          >            <treeselect              :id="'systemDiagnose_' + i"              v-model="k.diagnose_types"              :options="system_diagnose_types"              placeholder="- choose -"              :multiple="true"            ></treeselect>          </b-form-group>        </b-col>      </div>    </div>    <div v-for="(k, i) in problems" :key="i" class="overflow-visible">      <div class="mb-2">        <b-col cols="12">          <div class="flex-space-between">            <p class="number mr-2">{{ i + 1 }}</p>            <div class="hl align-self-center"></div>            <i              class="ml-2 number bx bx-trash align-middle"              @click="remove(i)"            ></i>          </div>        </b-col>      </div>      <div>        <b-col cols="12">          <b-form-group            label="Choose conflict type"            :label-for="'conflictType_' + i"          >            <treeselect              :id="'conflictType_' + i"              v-model="k.conflict_type"              placeholder="- Choose -"              :multiple="false"              :options="conflict_types"              :clearable="false"            />            <p              :id="'conflictType_warning_' + i"              :ref="'conflictType_warning_' + i"              style="display: none"              class="color-red"            >              Please choose conflict type!            </p>          </b-form-group>        </b-col>      </div>      <div>        <b-row class="mx-1">          <b-col cols="6">            <b-form-group label="Regulations" :label-for="'regulations_' + i">              <treeselect                :id="'regulations_' + i"                v-model="k.regulation"                placeholder="- Choose -"                :multiple="false"                :options="regulations"                :clearable="false"                @select="getDutyButton"              />              <p                :id="'regulations_warning_' + i"                style="display: none"                class="color-red"              >                Please choose regulation!              </p>            </b-form-group>          </b-col>          <b-col cols="6">            <b-form-group label="Regulation duty" :label-for="'duty_' + i">              <treeselect                :id="'duty_' + i"                v-model="k.duty"                placeholder="- Choose -"                :multiple="false"                :options="duty"                :clearable="false"              />              <p                :id="'duty_warning_' + i"                style="display: none"                class="color-red"              >                Please choose regulation duty!              </p>            </b-form-group>          </b-col>        </b-row>      </div>      <div>        <b-col cols="12">          <b-form-group            label="Insert conflict reason"            :label-for="'reason_' + i"          >            <b-form-input              :id="'reason_' + i"              v-model="k.reason"              type="text"              required              :value="k.reason"              name="name"            ></b-form-input>            <p              :id="'reason_warning_' + i"              style="display: none"              class="color-red"            >              Please insert conflict reason!            </p>          </b-form-group>        </b-col>      </div>      <div>        <b-col cols="12">          <b-form-group            label="Insert suggestion for conflict"            :label-for="'suggest_' + i"          >            <b-form-input              :id="'suggest_' + i"              v-model="k.suggestion"              type="text"              required              name="name"            ></b-form-input>            <p              :id="'suggestion_warning_' + i"              style="display: none"              class="color-red"            >              Please insert suggestion for conflict!            </p>          </b-form-group>        </b-col>      </div>      <div>        <b-col cols="12">          <b-form-group label="Is task related?">            <b-form-checkbox              v-model="k.isSelected"              switch              class="mr-n2"              @input="isChecked(k)"            >              <span class="sr-only">Switch for previous text input</span>            </b-form-checkbox>          </b-form-group>        </b-col>      </div>      <div v-if="k.isSelected === true">        <b-col cols="12">          <b-form-group label="Choose related task" :label-for="'task_' + i">            <treeselect              :id="'task_' + i"              v-model="k.task"              placeholder="- Choose -"              :multiple="false"              :options="task"              :clearable="false"              @select="getTaskDetailButton"            />            <p              :id="'task_warning_' + i"              style="display: none"              class="color-red"            >              Please choose related task!            </p>          </b-form-group>        </b-col>      </div>      <div v-if="k.isSelected === true">        <b-col cols="12">          <b-form-group            label="Choose related task's stage"            :label-for="'taskDetail_' + i"          >            <treeselect              :id="'taskDetail_' + i"              v-model="k.task_stage"              :options="task_stage"              placeholder="- choose -"              :disable-branch-nodes="true"              :show-count="true"            ></treeselect>            <p              :id="'taskDetail_warning_' + i"              style="display: none"              class="color-red"            >              Please choose related task's stage!            </p>          </b-form-group>        </b-col>      </div>      <div>        <b-col cols="12">          <b-form-group            v-if="dailyCheckCreateJson.diagnose_types"            label="Choose diagnoses for conflict"            :label-for="'diagnose_' + i"          >            <treeselect              :id="'diagnose_' + i"              v-model="k.diagnose_types"              :options="diagnose_types"              placeholder="- choose -"              :multiple="true"            ></treeselect>            <div              :id="'diagnose_warning_' + i"              style="display: none"              class="color-red"            >              Please choose diagnoses for conflict!            </div>          </b-form-group>        </b-col>      </div>    </div>    <div>      <b-col class="mb-5 pb-2" cols="12">        <div class="btn btn-secondary" @click="addReport">          <p>Add conflict</p>        </div>      </b-col>    </div>  </b-form></template><script>import Treeselect from '@riophae/vue-treeselect';import '@riophae/vue-treeselect/dist/vue-treeselect.css';export default {  name: 'AddProblem',  components: {    Treeselect,  },  props: {    problemData: {      type: Array,      default: () => [],    },    systemProblemData: {      type: Array,      default: () => [],    },  },  data() {    return {      problems: [],      systemProblem: [],      dailyCheckCreateJson: {        conflict_types: [],        diagnose_types: [],        employee_check: {},        regulations: [],        system_problems: [],      },      conflict_types: [],      regulations: [],      diagnose_types: [],      system_diagnose_types: [],      duty: [],      task: [],      system_conflict_types: [],      system_regulations: [],      system_duty: [],      system_task: [],      task_stage: [],      taskStages: [],      taskData: [],      employeeId: null,    };  },  watch: {    systemProblem: {      handler: function (data) {        const jsonData = {          problemData: [],          systemProblem: data,          dailycheck_id: this.dailyCheckCreateJson.employee_check.id,        };        this.$emit('emit_data', jsonData);      },      deep: true,    },    problems(newData) {      if (Object.keys(newData).length !== 0) {        const data = newData;        for (const i in data) {          if (data[i].task_stage) {            for (const j in this.taskStages) {              for (const k in this.taskStages[j].task_stages) {                if (                  this.taskStages[j].task_stages[k].id === data[i].task_stage                ) {                  data[i].stage = this.taskStages[j].task_stages[k].stage.id;                }              }            }          }          if (data[i].conflict_type) {            for (const j in this.dailyCheckCreateJson.conflict_types) {              if (                this.dailyCheckCreateJson.conflict_types[j].id ===                data[i].conflict_type              ) {                data[i].conflict_category =                  this.dailyCheckCreateJson.conflict_types[                    j                  ].key_information_deep_category;              }            }          }          if (data[i].duty) {            for (const j in this.duty) {              if (this.duty[j].id === data[i].duty) {                data[i].duty_type = this.duty[j].duty_type;                data[i].point = this.duty[j].point;              }            }          }        }        const jsonData = {          problemData: data,          systemProblem: this.systemProblem,          dailycheck_id: this.dailyCheckCreateJson.employee_check.id,        };        delete jsonData.systemProblem.isSelected;        jsonData.systemProblem.updated_date = new Date();        jsonData.systemProblem.updated_user = this.employeeId;        this.$emit('emit_data', jsonData);      }    },  },  mounted() {    if (this.$route.name === 'crucialInfo04') {      this.employeeId = this.$route.params.id;    } else {      this.employeeId = this.$store.getters.user.partner_id;    }    this.dailyCheckCreateJson = this.$store.getters['dailyCheckCreate'];    this.problems = this.setProblems(this.problemData);    this.systemProblem = this.dailyCheckCreateJson.system_problems;    if (this.systemProblem) {      const param =        this.$store.getters.activeCompany +        '/?exclude_state=complete&is_active=1&page_size=1000&executing_employee=' +        this.employeeId;      this.getTaskByOrgId(param);      //  ,      this.treeSelectData(        this.dailyCheckCreateJson.diagnose_types,        this.diagnose_types      );      for (const i in this.diagnose_types) {        this.system_diagnose_types.push({ ...this.diagnose_types[i] });      }      for (const j in this.systemProblem) {        for (const i in this.systemProblemData) {          if (this.systemProblemData[i].id === this.systemProblem[j].id) {            this.systemProblem[j].diagnose_types =              this.systemProblemData[j].diagnose_types;          }        }        this.systemProblem[j].updated_date = new Date();        this.systemProblem[j].updated_user = this.employeeId;        for (const l in this.systemProblem[j].diagnose_types) {          for (const o in this.system_diagnose_types) {            if (              this.system_diagnose_types[o].id ===              this.systemProblem[j].diagnose_types[l]            ) {              this.system_diagnose_types[o].isDisabled = true;              // console.log(this.system_diagnose_types[o]);              console.log(this.diagnose_types[o]);            }          }        }      }    }    const conflictTypes = []; //is_abnormal    for (const i in this.dailyCheckCreateJson.conflict_types) {      if (this.dailyCheckCreateJson.conflict_types[i].is_abnormal) {        conflictTypes.push(this.dailyCheckCreateJson.conflict_types[i]);      }    }    this.treeSelectData(conflictTypes, this.conflict_types);    this.treeSelectData(      this.dailyCheckCreateJson.regulations,      this.regulations    );    this.treeSelectData(conflictTypes, this.system_conflict_types, true);    this.treeSelectData(      this.dailyCheckCreateJson.regulations,      this.system_regulations,      true    );    for (const i in this.systemProblem) {      if (this.systemProblem[i].task) {        this.systemProblem[i].isSelected = true;      }    }  },  methods: {    treeSelectData(data, target, target2 = false, withCode = false) {      const changingData = data;      for (const i in changingData) {        const jsonData = {};        if (withCode) {          jsonData.id = changingData[i].id;          jsonData.label = changingData[i].code + ' - ' + changingData[i].name;        } else {          jsonData.id = changingData[i].id;          jsonData.label = changingData[i].name;        }        if (target2) {          const jsonData2 = jsonData;          jsonData2.isDisabled = true;          target.push(jsonData2);        } else {          target.push(jsonData);        }      }    },    changeStyle(id, index, style) {      this.$refs[id + '_warning_' + index].style.display = style;    },    async getTaskDetailById(params) {      const response = await this.$store.dispatch('getTaskDetailById', params);      if (response.status === 200) {        const list = [];        const taskStageGroups = response.data.task_stage_groups;        for (const i in taskStageGroups) {          const jsonData = { id: 0, label: '', children: [] };          jsonData.id = taskStageGroups[i].id;          jsonData.label =            taskStageGroups[i].stage_group.code +            ' - ' +            taskStageGroups[i].stage_group.name;          for (const j in taskStageGroups[i].task_stages) {            const josnData = {};            josnData.id = taskStageGroups[i].task_stages[j].id;            josnData.stage = taskStageGroups[i].task_stages[j].stage.id;            josnData.label =              taskStageGroups[i].task_stages[j].stage.code +              ' - ' +              taskStageGroups[i].task_stages[j].stage.name;            jsonData.children.push(josnData);          }          list.push(jsonData);        }        this.task_stage = list;        this.taskStages = taskStageGroups;        this.taskData = response.data;        return response.data;      }    },    async getTaskByOrgId(params) {      const response = await this.$store.dispatch('getTaskByOrgId', params);      if (response.status === 200) {        this.system_task = [];        this.task = [];        this.treeSelectData(response.data.results, this.task);        this.treeSelectData(response.data.results, this.system_task, true);      }    },    async getDuty(params) {      const response = await this.$store.dispatch('getDuty', params);      if (response.status === 200) {        this.system_duty = [];        this.treeSelectData(response.data.results, this.system_duty, true);        this.duty = [];        const dutys = response.data.results;        for (const i in dutys) {          const jsonData = {};          jsonData.id = dutys[i].id;          jsonData.label = dutys[i].code + ' - ' + dutys[i].name;          jsonData.duty_type = dutys[i].dtp_id;          jsonData.point = dutys[i].dtp_point;          this.duty.push(jsonData);        }      }    },    remove(id) {      this.problems.splice(id, 1);    },    getDutyButton(option) {      const id = option.id;      const param =        '?is_active=1&is_title=false&page_size=1000&regulation=' + id;      this.getDuty(param);    },    isChecked(key) {      if (key.isSelected === true) {        const param =          this.$store.getters.activeCompany +          '/?exclude_state=complete&is_active=1&page_size=1000&executing_employee=' +          this.employeeId;        this.getTaskByOrgId(param);      }    },    getTaskDetailButton(option) {      const id = option.id;      const param = id + '/';      this.getTaskDetailById(param);    },    async addReport() {      this.dailyCheckCreateJson = await this.$store.getters['dailyCheckCreate'];      if (this.dailyCheckCreateJson !== null) {        this.problems.push({});      }    },    async getRegulationByDuty(params, regulations, index) {      const response = await this.$store.dispatch('getDuty', params);      if (response.status === 200) {        const result = response.data.results[0];        let regulation = 0;        for (const i in regulations) {          if (regulations[i].id === parseInt(result.reg_id)) {            regulation = regulations[i].id;          }        }        const param =          '?is_active=1&is_title=false&page_size=1000&regulation=' + regulation;        await this.getDuty(param);        this.problems[index].regulation = parseInt(regulation);        this.problems[index].duty = parseInt(result.id);        // this.problems[index].duty_type = parseInt(result.dtp_id);        // this.problems[index].point = parseFloat(result.dtp_point);        this.problems.push({});        this.problems.pop();      }    },    setProblems(data) {      const problemData = data;      console.log('prev-problemData', problemData);      for (const j in problemData) {        // if (problemData[j].conflict_type) {        //   const conflictType = this.$store.getters['dailyCheckCreate']        //     .conflict_types;        //   for (const i in conflictType) {        //     if (conflictType[i].id === problemData[j].conflict_type) {        //       problemData[j].conflict_type = conflictType[i];        //       delete problemData[j].conflict_category;        //     }        //   }        // }        // if (problemData[j].diagnose_types) {        //   const diagnoseList = [];        //   const diagnoseTypesData = problemData[j].diagnose_types;        //   for (const i in diagnoseTypesData) {        //     const diagnoseTypes = this.$store.getters['dailyCheckCreate']        //       .diagnose_types;        //     for (const l in diagnoseTypes) {        //       if (diagnoseTypesData[i] === diagnoseTypes[l].id) {        //         diagnoseList.push(diagnoseTypes[l]);        //       }        //     }        //   }        //   problemData[j].diagnose_types = diagnoseList;        //   delete problemData[j].diagnoseTypes;        // }        if (problemData[j].duty) {          const regulations = this.dailyCheckCreateJson.regulations;          const params = '?is_active=1&id=' + problemData[j].duty;          this.getRegulationByDuty(params, regulations, j);        }        if (problemData[j].task) {          problemData[j].isSelected = true;          const params = problemData[j].task + '/';          this.getTaskDetailById(params);          const param =            this.$store.getters.activeCompany +            '/?exclude_state=complete&is_active=1&page_size=1000&executing_employee=' +            this.employeeId;          this.getTaskByOrgId(param);        }        // if (problemData[j].stage) {        //   const algorithms = this.$store.getters.company.algorithm;        //   for (const i in algorithms) {        //     const algStageGroup = algorithms[i].stage_groups;        //     for (const l in algStageGroup) {        //       const algStage = algStageGroup[l].stages;        //       for (const m in algStage) {        //         if (algStage[m].id === problemData[j].stage) {        //           problemData[j].task_stage_id = problemData[j].task_stage;        //           problemData[j].task_stage =        //             algStage[m].code + ' - ' + algStage[m].name;        //         }        //       }        //     }        //   }        // }      }      console.log('after-problemData', problemData);      return problemData;    },  },};</script><style scoped>.dropdown {  border: 1px solid #ced4da;  width: 100%;}.btn-secondary {  background-color: #2a3042;  color: white;}</style>