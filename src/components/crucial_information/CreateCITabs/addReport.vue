<template>  <b-form class="d-block mt-3 overflow-auto">    <div v-for="(k, i) in report" :key="i">      <div class="mb-2">        <b-col cols="12">          <div class="flex-space-between">            <p class="number mr-2">{{ i + 1 }}</p>            <div class="hl align-self-center"></div>            <i              class="ml-2 number bx bx-trash align-middle"              @click="remove(i)"            ></i>          </div>        </b-col>      </div>      <div class="flex-space-between">        <b-col cols="2">          <img            v-if="!k.img"            src="https://tuss.io/tusd_images/profile/human_icon.png"            class="img-thumbnail rounded-circle mr-2"            width="64"            alt          />          <img            v-else            :id="'tooltip_img_' + i"            :src="k.img"            onError="this.onerror=null;this.src='https://tuss.io/tusd_images/profile/human_icon.png';"            class="img-thumbnail rounded-circle mr-2"            style="border-radius: 25px"            width="64"            alt          />        </b-col>        <b-col cols="10">          <b-form-group label="Please choose employee" label-for="employee">            <treeselect              id="employee"              v-model="k.employee"              placeholder="- Choose -"              :multiple="false"              :options="employees"              :clearable="false"              @input="changeImg(k.employee, i)"            />          </b-form-group>        </b-col>      </div>      <div>        <b-row class="mx-1">          <b-col cols="6">            <b-form-group label="Regulations" :label-for="'regulations_' + i">              <treeselect                :id="'regulations_' + i"                v-model="k.regulation"                placeholder="- Choose -"                :multiple="false"                :options="regulations"                :clearable="false"                @select="getDutyButton"              />              <p                :id="'regulations_warning_' + i"                style="display: none"                class="color-red"              >                Please choose regulation!              </p>            </b-form-group>          </b-col>          <b-col cols="6">            <b-form-group label="Regulation duty" :label-for="'duty_' + i">              <treeselect                :id="'duty_' + i"                v-model="k.duty"                placeholder="- Choose -"                :multiple="false"                :options="duty"                :clearable="false"              />              <p                :id="'duty_warning_' + i"                style="display: none"                class="color-red"              >                Please choose regulation duty!              </p>            </b-form-group>          </b-col>        </b-row>      </div>      <div>        <b-col cols="12">          <b-form-group            label="Insert reminder reason"            :label-for="'reason_' + i"          >            <b-form-input              :id="'reason_' + i"              v-model="k.reason"              type="text"              required              :value="k.reason"              name="name"            ></b-form-input>          </b-form-group>        </b-col>      </div>      <div>        <b-col cols="12">          <b-form-group            label="Insert suggestion for reminder"            :label-for="'suggest_' + i"          >            <b-form-input              :id="'suggest_' + i"              v-model="k.suggestion"              type="text"              required              name="name"            ></b-form-input>          </b-form-group>        </b-col>      </div>      <b-col cols="8">        <b-form-group label="Is task related?">          <b-form-checkbox            v-model="k.isSelected"            switch            class="mr-n2"            @input="isChecked(k)"          >            <span class="sr-only">Switch for previous text input</span>          </b-form-checkbox>        </b-form-group>      </b-col>      <div v-if="k.isSelected === true">        <b-col cols="12">          <b-form-group label="Choose related task" :label-for="'task_' + i">            <treeselect              :id="'task_' + i"              v-model="k.task"              placeholder="- Choose -"              :multiple="false"              :options="task"              :clearable="false"              @select="getTaskDetailButton"            />          </b-form-group>        </b-col>      </div>      <div v-if="k.isSelected === true">        <b-col cols="12">          <b-form-group            label="Choose related task's stage"            :label-for="'taskDetail_' + i"          >            <treeselect              :id="'taskDetail_' + i"              v-model="k.task_stage"              :options="taskDetail"              placeholder="- choose -"              :disable-branch-nodes="true"              :show-count="true"            ></treeselect>          </b-form-group>        </b-col>      </div>    </div>    <div>      <b-col class="mb-5 pb-2" cols="12">        <div class="btn btn-secondary" @click="addReport">          <p>Анхааруулга нэмэх</p>        </div>      </b-col>    </div>  </b-form></template><script>import Treeselect from '@riophae/vue-treeselect';import '@riophae/vue-treeselect/dist/vue-treeselect.css';export default {  name: 'AddReport',  components: { Treeselect },  props: {    reminderData: {      type: Array,      default: () => [],    },  },  data() {    return {      report: [],      dailyCheckCreateJson: {        employee_check: {},        regulations: [],        system_problems: [],      },      employees: [],      regulations: [],      task: [],      duty: [],      taskDetail: [],      taskStages: [],      taskData: [],    };  },  watch: {    report(newData) {      if (Object.keys(newData).length !== 0) {        const data = newData;        for (const i in data) {          if (data[i].task_stage) {            for (const j in this.taskStages) {              for (const k in this.taskStages[j].task_stages) {                if (                  this.taskStages[j].task_stages[k].id === data[i].task_stage                ) {                  data[i].stage = this.taskStages[j].task_stages[k].stage.id;                }              }            }          }          const conflictType = this.$store.getters['dailyCheckCreate'];          for (const j in conflictType) {            if (j === 'conflict_types') {              for (const l in conflictType[j]) {                if (conflictType[j][l].conflict_type === 'reminder') {                  data[i].conflict_category = conflictType[j][l].conflict_type;                  data[i].conflict_type = conflictType[j][l].id;                }              }            }          }          const jsonData = {            reminderData: data,            dailycheck_id: this.dailyCheckCreateJson.employee_check.id,          };          this.$emit('emit_data', jsonData);        }      }    },  },  mounted() {    this.dailyCheckCreateJson = this.$store.getters['dailyCheckCreate'];    const employeeData = this.$store.getters.company.employees;    const activeEmployee = [];    for (const i in employeeData) {      if (employeeData[i].is_active === '1') {        employeeData[i].label =          employeeData[i].partner__last_name +          ' ' +          employeeData[i].partner__name;        employeeData[i].id = employeeData[i].partner__id;        activeEmployee.push(employeeData[i]);      }    }    this.employees = activeEmployee;    this.treeSelectData(      this.dailyCheckCreateJson.regulations,      this.regulations    );    this.report = this.setReminders(this.reminderData);  },  methods: {    changeImg(data, index) {      const employeeData = this.$store.getters.company.employees;      for (const i in employeeData) {        if (employeeData[i].partner__id === data) {          this.report[index].img = employeeData[i].partner__picture;        }      }    },    treeSelectData(data, target, withCode = false) {      const changingData = data;      for (const i in changingData) {        const jsonData = {};        if (withCode) {          jsonData.id = changingData[i].id;          jsonData.label = changingData[i].code + ' - ' + changingData[i].name;        } else {          jsonData.id = changingData[i].id;          jsonData.label = changingData[i].name;        }        target.push(jsonData);      }    },    changeStyle(id, index, style) {      this.$refs[id + '_warning_' + index].style.display = style;    },    async getTaskDetailById(params) {      const response = await this.$store.dispatch('getTaskDetailById', params);      if (response.status === 200) {        const list = [];        const taskStageGroups = response.data.task_stage_groups;        for (const i in taskStageGroups) {          const jsonData = { id: 0, label: '', children: [] };          jsonData.id = taskStageGroups[i].id;          jsonData.label =            taskStageGroups[i].stage_group.code +            ' - ' +            taskStageGroups[i].stage_group.name;          for (const j in taskStageGroups[i].task_stages) {            const josnData = {};            josnData.id = taskStageGroups[i].task_stages[j].id;            josnData.label =              taskStageGroups[i].task_stages[j].stage.code +              ' - ' +              taskStageGroups[i].task_stages[j].stage.name;            jsonData.children.push(josnData);          }          list.push(jsonData);        }        this.taskDetail = list;        this.taskStages = taskStageGroups;        this.taskData = response.data;        return response.data;      }    },    async getTaskByOrgId(params) {      const response = await this.$store.dispatch('getTaskByOrgId', params);      if (response.status === 200) {        this.task = [];        this.treeSelectData(response.data.results, this.task);      }    },    async getDuty(params) {      const response = await this.$store.dispatch('getDuty', params);      if (response.status === 200) {        this.duty = [];        const dutys = response.data.results;        for (const i in dutys) {          const jsonData = {};          jsonData.id = dutys[i].id;          jsonData.label = dutys[i].code + ' - ' + dutys[i].name;          jsonData.dtp_id = dutys[i].dtp_id;          jsonData.dtp_point = dutys[i].dtp_point;          this.duty.push(jsonData);        }      }    },    remove(id) {      this.report.splice(id, 1);    },    getDutyButton(option) {      const id = option.id;      const param =        '?is_active=1&is_title=false&page_size=1000&regulation=' + id;      this.getDuty(param);    },    isChecked(key) {      if (key.isSelected === true) {        const param =          this.$store.getters.activeCompany +          '/?page_size=1000&executing_employee=' +          key.employee;        this.getTaskByOrgId(param);      }    },    getTaskDetailButton(option) {      const id = option.id;      const param = id + '/';      this.getTaskDetailById(param);    },    addReport() {      if (this.dailyCheckCreateJson !== null) {        this.report.push({});      }    },    setReminders(data) {      const reminderData = data;      console.log('prev-reminderData', reminderData);      for (const j in reminderData) {        // if (reminderData[j].employee) {        //   const employeeData = this.$store.getters.company.employees;        //   this.employees = employeeData;        //   for (const i in employeeData) {        //     employeeData[i].full_name =        //       employeeData[i].last_name + ' ' + employeeData[i].name;        //     if (employeeData[i].partner__id === reminderData[j].employee) {        //       reminderData[j].employee = employeeData[i];        //     }        //   }        // }        //        // if (reminderData[j].duty) {        //   const regulations = this.$store.getters['dailyCheckCreate']        //     .regulations;        //   const param = '?is_active=1&id=' + reminderData[j].duty;        //   this.$store.dispatch('getDuty', param).then(function (response) {        //     const result = response.data.results[0];        //     reminderData[j].duty = result;        //     for (const i in regulations) {        //       if (regulations[i].id === parseInt(result.reg_id)) {        //         reminderData[j].regulation = regulations[i];        //       }        //     }        //   });        // }        // if (reminderData[j].task) {        //   reminderData[j].isSelected = true;        //   const params = reminderData[j].task + '/';        //   this.getTaskDetailById(params).then(function (result) {        //     reminderData[j].task = result;        //     const param =        //       this.$store.getters.activeCompany +        //       '/?page_size=1000&executing_employee=' +        //       this.$route.params.id;        //     this.getTaskByOrgId(param);        //   });        // }        // if (reminderData[j].stage) {        //   const algorithms = this.$store.getters.company.algorithm;        //   for (const i in algorithms) {        //     const algStageGroup = algorithms[i].stage_groups;        //     for (const l in algStageGroup) {        //       const algStage = algStageGroup[l].stages;        //       for (const m in algStage) {        //         if (algStage[m].id === reminderData[j].stage) {        //           reminderData[j].task_stage_id = reminderData[j].task_stage;        //           reminderData[j].task_stage =        //             algStage[m].code + ' - ' + algStage[m].name;        //         }        //       }        //     }        //   }        // }        if (reminderData[j].duty) {          const regulations = this.dailyCheckCreateJson.regulations;          const params = '?is_active=1&id=' + reminderData[j].duty;          this.$store.dispatch('getDuty', params).then(function (response) {            const result = response.data.results[0];            reminderData[j].duty = result.id;            for (const i in regulations) {              if (regulations[i].id === parseInt(result.reg_id)) {                reminderData[j].regulation = regulations[i].id;              }            }          });          const param =            '?is_active=1&is_title=false&page_size=1000&regulation=' +            reminderData[j].regulation;          this.getDuty(param);        }        if (reminderData[j].task) {          reminderData[j].isSelected = true;          const params = reminderData[j].task + '/';          this.getTaskDetailById(params);          const param =            this.$store.getters.activeCompany +            '/?is_active=1&page_size=1000&executing_employee=' +            reminderData[j].employee;          this.getTaskByOrgId(param);        }      }      console.log('after-reminderData', reminderData);      return reminderData;    },  },};</script><style scoped>.dropdown {  border: 1px solid #ced4da;  width: 100%;}.btn-secondary {  background-color: #2a3042;  color: white;}</style>