<template>  <div>    <b-col v-if="this.$route.params.type !== 'employee'" class="ml-2" cols="12">      <b-col cols="12" class="d-flex">        <div          id="toggle-left"          class="btn btn-secondary"          :class="{ sendCI: view === 'employeeView' }"          @click="employeeView"        >          <i class="bx bx-user-detail mr-2"></i>Employee view        </div>        <div          id="toggle-right"          class="btn btn-secondary"          :class="{ sendCI: view === 'taskView' }"          @click="taskView"        >          <i class="bx bx-task mr-2"></i>Task view        </div>      </b-col>    </b-col>    <b-col cols="12" class="ml-2" style="min-width: 1060px">      <b-col cols="12">        <CIPerfCard :data="dashboard" :date="weekDate" />      </b-col>    </b-col>    <b-col v-if="view === 'employeeView'" cols="12" style="min-width: 590px">      <div class="card pt-4 pl-4 pr-3 pb-3 bg-white">        <div class="d-flex">          <div            v-if="this.$route.params.type === 'employee'"            class="btn btn-secondary mr-3"            @click="showMyPlan"          >            <i class="bx bxs-user-check mr-2"></i>My tasks          </div>          <!--          <div-->          <!--            v-if="this.$route.params.type === 'employee'"-->          <!--            class="btn btn-secondary mr-3"-->          <!--            @click="showHiddenDiv"-->          <!--          >-->          <!--            <i class="bx bx-filter mr-2"></i>Show completed stages-->          <!--          </div>-->          <div            v-if="this.$route.params.type === 'employee'"            class="btn btn-secondary mr-3"            @click="showAllTaskDetail"          >            <i class="bx bx-expand-alt mr-2"></i>Expand All          </div>          <div            v-if="this.$route.params.type === 'employee'"            class="btn btn-secondary mr-3"            @click="showDueTasks"          >            <i class="bx bx-error mr-2"></i>Due Tasks          </div>          <!--          <div-->          <!--            v-if="this.$route.params.type === 'department' && approveButton"-->          <!--            class="sendCI btn btn-secondary mr-2 ml-auto"-->          <!--            @click="approveAll"-->          <!--          >-->          <!--            Confirm all-->          <!--          </div>-->          <div class="mr-2 ml-auto">            <div              v-if="                this.$route.params.type === 'employee' &&                saveButton &&                !ach1Auto              "              class="sendCI btn btn-secondary"              @click="saveCI"            >              Save            </div>          </div>          <div            v-if="this.$route.params.type === 'employee' && sendButton"            class="sendCI btn btn-secondary"            @click="sendCI"          >            Send          </div>        </div>        <Table          v-if="$route.params.type === 'employee'"          :tasks.sync="PlanData"          :detail-view="detailView"          :show-my-task="showMyTask"          :planned-task="CIWeeklyPlanData.critical_info"          :hide="hideCrusialInfoPlan"          :due-tasks="dueTasks"          class="pt-3"          @task_data="taskChange"        />        <orgDepTable          v-else          :table-data="orgDepEmployeeCIData"          :detail-view="detailView"          class="pt-3"          @checked_criticalInfo="emitCriticalInfo"        />      </div>    </b-col>    <b-col v-if="view === 'taskView'" cols="12" style="min-width: 590px">      <div class="card pt-4 pl-4 pr-3 pb-3 bg-white">        <div class="d-flex">          <div class="btn btn-secondary mr-3" @click="showAllTaskDetail">            <i class="bx bx-expand-alt mr-2"></i>Expand All          </div>          <div class="btn btn-secondary mr-3" @click="showDueTasks">            <i class="bx bx-error mr-2"></i>Due Tasks          </div>        </div>        <taskViewTable          :table-data="orgDepEmployeeCIData"          :detail-view="detailView"          class="pt-3"        />      </div>    </b-col>  </div></template><script>import CIPerfCard from '@/components/crucial_information/CIPerfCards';import Table from '@/components/crucial_information/tables/createCITable';import orgDepTable from '@/components/crucial_information/tables/nextWeekCIApproveTable';import taskViewTable from '@/components/crucial_information/tables/nextWeekCITaskViewTable';export default {  name: 'CINextWeekTab',  components: {    CIPerfCard,    Table,    orgDepTable,    taskViewTable,  },  data() {    return {      ach1Auto: this.permission('ach1_ato'),      view: 'employeeView',      criticalInfoId: null,      CIWeeklyPlanData: {        critical_info: { state: null, plan_tasks: null, json_data: null },      },      PlanData: [],      PlannedData: [],      weekDate: '',      employees: [],      detailView: false,      dashboard: {        Total_planned_hour: '00:00',        Due_stages: '0',        State: { state: 'Loading', color: 'text-warning' },      },      sendButton: false,      saveButton: false,      approveButton: false,      isNextWeekPlanCreated: false,      plannedStageCount: 0,      showMyTask: false,      hideCrusialInfoPlan: false,      orgDepEmployeeCIData: [],      criticalInfoList: [],      dueTasks: false,    };  },  watch: {    CIWeeklyPlanData: {      handler: function (newData) {        if (newData.algorithms) {          const planTask = newData.plan_tasks;          const algorithms = newData.algorithms;          const departments = newData.departments;          const subFunctions = newData.subfunctions;          let criticalInfo = [];          if (newData.critical_info.json_data !== null) {            criticalInfo = newData.critical_info.json_data.planned_tasks;          }          const plan_list = [];          for (const i in planTask) {            const taskJson = {};            let checker = false;            taskJson.due_task = planTask[i].due_task;            taskJson.is_conflicted = planTask[i].is_conflicted;            taskJson.is_regulated = planTask[i].is_regulated;            taskJson.task_code = planTask[i].task_code;            taskJson.task_name = planTask[i].task_name;            taskJson.task_id = planTask[i].task_id;            taskJson.task_algorithm = planTask[i].task_algorithm;            let totalHour = 0;            let totalMin = 0;            for (const p in criticalInfo) {              if (                criticalInfo[p].plan_hour &&                criticalInfo[p].task === taskJson.task_id              ) {                const planHour = criticalInfo[p].plan_hour;                const splicedList = planHour.split(':');                const intPlanHour = parseInt(splicedList[0]);                const intPlanMin = parseInt(splicedList[1]);                totalHour += intPlanHour;                totalMin += intPlanMin;              }            }            if (criticalInfo.length > 0) {              if (!totalHour.toString().charAt(1)) {                totalHour = '0' + totalHour;              }              if (!totalMin.toString().charAt(1)) {                totalMin = '0' + totalMin;              }              taskJson.task_planned_hour = totalHour + ':' + totalMin;            } else {              taskJson.task_planned_hour = '00:00';            }            taskJson.task_start_date = planTask[i].task_start_date;            taskJson.task_end_date = planTask[i].task_end_date;            for (const o in this.employees) {              if (                planTask[i].task_executing_employee ===                  this.employees[o].partner__id &&                this.employees[o].is_active === '1'              ) {                taskJson.task_executing_employee =                  this.employees[o].partner__last_name +                  ' ' +                  this.employees[o].partner__name;                taskJson.executing_employee_id = this.employees[o].partner__id;              }            }            for (const j in departments) {              if (departments[j].id === planTask[i].task_department) {                taskJson.task_departments_name = departments[j].name;                taskJson.task_departments_short_name =                  departments[j].short_name;                taskJson.task_departments_id = departments[j].id;              }            }            for (const j in algorithms) {              if (algorithms[j].id === planTask[i].task_algorithm) {                taskJson.task_algorithm_name = algorithms[j].name;                taskJson.task_algorithm_code = algorithms[j].code;                const stageGroup = algorithms[j].stage_groups;                const taskStageGroup = planTask[i].task_stage_groups;                const taskStageGroupsArray = [];                for (const k in stageGroup) {                  for (const l in taskStageGroup) {                    let stageChecker = false;                    if (stageGroup[k].id === taskStageGroup[l].stage_group) {                      const stage = stageGroup[k].stages;                      const taskStage = taskStageGroup[l].task_stages;                      const stageData = [];                      const progress = {};                      let complete = 0;                      let onQueue = 0;                      let onProcess = 0;                      let maxPorgress = 0;                      for (const m in stage) {                        for (const n in taskStage) {                          if (stage[m].id === taskStage[n].stage) {                            const taskStageJson = {};                            taskStageJson.code = stage[m].code;                            taskStageJson.name = stage[m].name;                            taskStageJson.end_date = taskStage[n].end_date;                            taskStageJson.state = taskStage[n].state;                            taskStageJson.algorithm = algorithms[j].id;                            taskStageJson.task_stage_id =                              taskStage[n].task_stage_id;                            for (const z in this.PlannedData) {                              if (                                this.PlannedData[z].task_stage ===                                taskStageJson.task_stage_id                              ) {                                taskStageJson.plan_time =                                  this.PlannedData[z].plan_hour;                                checker = true;                                stageChecker = true;                                taskStageJson.hidden = true;                              } else {                                taskStageJson.hidden = false;                              }                            }                            if (                              this.ach1Auto &&                              taskStage[n].recommended_hour                            ) {                              taskStageJson.plan_time =                                taskStage[n].recommended_hour;                              checker = true;                              stageChecker = true;                            }                            taskStageJson.task_stage_group_id =                              taskStage[n].task_stage_group_id;                            taskStageJson.task_id = taskStage[n].task_id;                            taskStageJson.form_id = taskStage[n].form;                            taskStageJson.entry_id = taskStage[n].entry;                            taskStageJson.start_date = taskStage[n].start_date;                            taskStageJson.employee_id = taskStage[n].employee;                            taskStageJson.department_id =                              taskJson.task_departments_id;                            taskStageJson.stage_group_id = stageGroup[k].id;                            taskStageJson.stage_id = stage[m].id;                            taskStageJson.is_due = taskStage[n].is_due;                            if (taskStage[n].is_due === true) {                              stageChecker = true;                            }                            maxPorgress += 1;                            if (taskStage[n].state === 'complete') {                              complete += 1;                            } else if (taskStage[n].state === 'on_queue') {                              onQueue += 1;                            } else if (taskStage[n].state === 'on_process') {                              onProcess += 1;                            }                            for (const o in this.employees) {                              if (                                taskStage[n].employee ===                                  this.employees[o].partner__id &&                                this.employees[o].is_active === '1'                              ) {                                taskStageJson.employeeImage =                                  this.employees[o].picture;                                taskStageJson.employeeName =                                  this.employees[o].partner__last_name +                                  ' ' +                                  this.employees[o].partner__name;                              }                            }                            stageData.push(taskStageJson);                          }                        }                      }                      const taskStageGRPJson = {};                      taskStageGRPJson.code = stageGroup[k].code;                      taskStageGRPJson.name = stageGroup[k].name;                      taskStageGRPJson.end_date = taskStageGroup[l].end_date;                      taskStageGRPJson.entry = taskStageGroup[l].entry;                      taskStageGRPJson.form = taskStageGroup[l].form;                      taskStageGRPJson.task_id = taskStageGroup[l].task_id;                      taskStageGRPJson.taskStageGRP_id =                        taskStageGroup[l].task_stage_group_id;                      taskStageGRPJson.stageGroup_id =                        taskStageGroup[l].stage_group;                      progress.complete = complete;                      progress.onQueue = onQueue;                      progress.onProcess = onProcess;                      progress.maxPorgress = maxPorgress;                      taskStageGRPJson.progress = progress;                      taskStageGRPJson.showStages = false;                      if (stageChecker === true) {                        taskStageGRPJson.showStages = true;                      }                      if (complete === maxPorgress) {                        taskStageGRPJson.state = 'stage_hide';                      } else {                        taskStageGRPJson.state = 'stage_show';                      }                      taskStageGRPJson.stage = stageData;                      taskStageGroupsArray.push(taskStageGRPJson);                    }                  }                  taskJson.task_stage_groups = taskStageGroupsArray;                }              }            }            for (const j in subFunctions) {              if (subFunctions[j].id === planTask[i].task_department) {                taskJson.task_departments_name = subFunctions[j].name;                taskJson.task_departments_code = subFunctions[j].code;              }            }            taskJson._showDetails = checker;            if (this.isNextWeekPlanCreated !== false) {              plan_list.push(taskJson);            }            // task_executing_employee: 26;          }          this.PlanData = plan_list;        }      },      deep: true,    },  },  beforeMount() {    if (this.permission('ach1_hm1')) {      this.approveButton = true;    }    if (this.permission('ach1_hm2')) {      if (this.$route.params.type !== 'organization') {        const departments = this.$store.getters.company.department;        for (const i in departments) {          if (            departments[i].manager__id === this.$store.getters.user.partner_id          ) {            this.approveButton = true;            this.saveButton = true;            this.sendButton = true;          }        }      }    }    if (      !this.saveButton &&      this.permission('ach1_upd') &&      parseInt(this.$route.params.id) === this.$store.getters.user.partner_id    ) {      this.saveButton = true;    }    if (      !this.sendButton &&      this.permission('ach1_snd') &&      parseInt(this.$route.params.id) === this.$store.getters.user.partner_id    ) {      this.sendButton = true;    }  },  mounted() {    this.employees = this.$store.getters.company.employees;    const weekId = this.$route.params.weekId;    this.weekDate = this.getWeek(weekId, true);    if (this.$route.params.type === 'employee') {      const urlData = this.weekDate + '/' + this.$route.params.id + '/';      this.getWeeklyCheckPlan(urlData);    } else {      const urlParam = this.$route.params.type + '=' + this.$route.params.id;      const weekList = weekId.split('-');      let planYear = parseInt(weekList[0]);      let planWeekNum = parseInt(weekList[1]);      planWeekNum += 1;      if (planWeekNum === 54) {        planWeekNum = 1;        planYear += 1;      }      const urlData = planYear + '/' + planWeekNum + '/?' + urlParam;      this.orgDepNextWeekCriticalInfo(urlData);    }  },  methods: {    employeeView() {      this.view = 'employeeView';      const weekId = this.$route.params.weekId;      const urlParam = this.$route.params.type + '=' + this.$route.params.id;      const weekList = weekId.split('-');      let planYear = parseInt(weekList[0]);      let planWeekNum = parseInt(weekList[1]);      planWeekNum += 1;      if (planWeekNum === 54) {        planWeekNum = 1;        planYear += 1;      }      const urlData = planYear + '/' + planWeekNum + '/?' + urlParam;      this.orgDepNextWeekCriticalInfo(urlData);    },    taskView() {      this.view = 'taskView';    },    taskChange(data) {      const dashBoardData = data;      this.dashboard.Total_planned_hour = dashBoardData.total_hour;      const due_stages = this.dashboard.Due_stages;      if (this.dashboard.State.state === 'Draft') {        const splitData = due_stages.split('/');        this.dashboard.Due_stages =          dashBoardData.dueStageCount + '/' + splitData[1];      } else {        this.dashboard.Due_stages = dashBoardData.dueStageCount;      }    },    checkStageDue() {      const planTask = this.CIWeeklyPlanData.plan_tasks;      const id = parseInt(this.$route.params.id);      let dueStageList = 0;      for (const i in planTask) {        const taskStageGroup = planTask[i].task_stage_groups;        for (const j in taskStageGroup) {          const stage = taskStageGroup[j].task_stages;          for (const k in stage) {            if (stage[k].is_due === true && stage[k].employee === id) {              dueStageList += 1;            }          }        }      }      const plannedTasks = this.PlannedData;      let totalHour = 0;      let totalMin = 0;      let plannedDueStage = 0;      for (const i in plannedTasks) {        const planHour = plannedTasks[i].plan_hour;        const splicedList = planHour.split(':');        const intPlanHour = parseInt(splicedList[0]);        const intPlanMin = parseInt(splicedList[1]);        totalHour += intPlanHour;        totalMin += intPlanMin;        if (totalMin >= 60) {          const min = Math.floor(totalMin / 60);          totalMin = totalMin - 60 * min;          totalHour += min;        }        if (plannedTasks[i].is_due && plannedTasks[i].is_assigned) {          plannedDueStage += 1;        }      }      if (!totalHour.toString().charAt(1)) {        totalHour = '0' + totalHour;      }      if (!totalMin.toString().charAt(1)) {        totalMin = '0' + totalMin;      }      const state = this.CIWeeklyPlanData.critical_info.state;      this.dashboard.Due_stages = plannedDueStage;      if (state === 'sent') {        this.dashboard.State = { state: 'Sent', color: 'text-warning' };        this.hideCrusialInfoPlan = true;        this.sendButton = false;        this.saveButton = false;      } else if (state === 'confirm') {        this.dashboard.State = 'Confirmed';        this.hideCrusialInfoPlan = true;        this.sendButton = false;        this.saveButton = false;      } else {        if (this.CIWeeklyPlanData.critical_info.description !== null) {          this.dashboard.State = { state: 'Rejected', color: 'text-danger' };        } else {          this.dashboard.State = { state: 'Draft', color: 'text-danger' };        }        this.hideCrusialInfoPlan = false;        this.dashboard.Due_stages = plannedDueStage + '/' + dueStageList;      }      this.dashboard.Total_planned_hour = totalHour + ':' + totalMin;    },    async updateNextWeekPlan(param, index = false) {      const response = await this.$store.dispatch('updateNextWeekPlan', param);      this.orgDepEmployeeCIData.push({});      if (index !== false) {        if (response.status === 200 && response.data.result) {          this.orgDepEmployeeCIData[index].state = 'confirm';          this.orgDepEmployeeCIData.pop();        }      } else if (        response.status === 200 &&        response.data.result &&        param.data.state === 'sent'      ) {        this.saveButton = false;        this.dashboard.State = { state: 'Sent', color: 'text-warning' };      }    },    async orgDepNextWeekCriticalInfo(urlData) {      const response = await this.$store.dispatch(        'orgDepNextWeekCriticalInfo',        urlData      );      if (response.status === 200) {        this.orgDepEmployeeCIData = response.data.critical_infos;        let totalHour = 0;        let totalMin = 0;        let checkNotConfirm = false;        for (const i in this.orgDepEmployeeCIData) {          const planHour = this.orgDepEmployeeCIData[i].total_work_hour;          const splicedList = planHour.split(':');          const intPlanHour = parseInt(splicedList[0]);          const intPlanMin = parseInt(splicedList[1]);          totalHour += intPlanHour;          totalMin += intPlanMin;          if (totalMin > 60) {            const min = Math.floor(totalMin / 60);            totalMin = totalMin - 60 * min;            totalHour += min;          }          if (this.orgDepEmployeeCIData[i].state !== 'confirm') {            checkNotConfirm = true;          }        }        if (!totalHour.toString().charAt(1)) {          totalHour = '0' + totalHour;        }        if (!totalMin.toString().charAt(1)) {          totalMin = '0' + totalMin;        }        this.dashboard = {};        this.dashboard.Total_planned_hour = totalHour + ':' + totalMin;        if (checkNotConfirm) {          this.dashboard.State = { state: 'Checking', color: 'text-warning' };        } else {          this.dashboard.State = 'Done';          this.approveButton = false;        }      }    },    async getTaskInfoByIds(param) {      const response = await this.$store.dispatch('getTaskInfoByIds', param);      if (response.status === 200) {        const data = response.data.return_data;        for (const i in data) {          const json = {            due_task: false,            is_conflicted: data[i].is_conflicted,            is_regulated: data[i].is_regulated,            task_algorithm: data[i].algorithm,            task_code: data[i].code,            task_department: data[i].department_id,            task_end_date: data[i].end_date,            task_executing_employee: data[i].executing_employee,            task_id: data[i].id,            task_name: data[i].name,            task_stage_groups: [],            task_start_date: data[i].start_date,            task_subfunction: data[i].sub_function_id,          };          this.CIWeeklyPlanData.plan_tasks.push(json);        }        const temp_list_taskStg = [];        for (const i in this.CIWeeklyPlanData.plan_tasks) {          for (const j in this.CIWeeklyPlanData.plan_tasks[i]            .task_stage_groups) {            for (const l in this.CIWeeklyPlanData.plan_tasks[i]              .task_stage_groups[j].task_stages) {              if (                !temp_list_taskStg.includes(                  this.CIWeeklyPlanData.plan_tasks[i].task_stage_groups[j]                    .task_stages[l].task_stage_id                )              ) {                temp_list_taskStg.push(                  this.CIWeeklyPlanData.plan_tasks[i].task_stage_groups[j]                    .task_stages[l].task_stage_id                );              }            }          }        }        const plan_tasks = this.CIWeeklyPlanData.plan_tasks;        const plannedStages =          this.CIWeeklyPlanData.critical_info.json_data.planned_tasks;        for (let o = 0; o < plannedStages.length; o++) {          for (const i in plan_tasks) {            if (plan_tasks[i].task_id === plannedStages[o].task) {              if (plan_tasks[i].task_stage_groups.length > 0) {                for (const j in plan_tasks[i].task_stage_groups) {                  if (                    plannedStages[o].task_stage_group ===                    plan_tasks[i].task_stage_groups[j].task_stage_group_id                  ) {                    if (                      plan_tasks[i].task_stage_groups[j].task_stages.length > 0                    ) {                      for (const l in plan_tasks[i].task_stage_groups[j]                        .task_stages) {                        if (                          plannedStages[o].task_stage !==                          plan_tasks[i].task_stage_groups[j].task_stages[l]                            .task_stage_id                        ) {                          let check = true;                          for (const n in plan_tasks[i].task_stage_groups[j]                            .task_stages) {                            if (                              plan_tasks[i].task_stage_groups[j].task_stages[n]                                .task_stage_id === plannedStages[o].task_stage                            ) {                              check = false;                            }                          }                          if (check) {                            const json = {                              employee: plannedStages[o].employee,                              end_date: plannedStages[o].end_date,                              entry: plannedStages[o].entry,                              form: plannedStages[o].form,                              is_due: plannedStages[o].is_due,                              recommended_hour: null,                              stage: plannedStages[o].stage,                              start_date: plannedStages[o].start_date,                              state: 'complete',                              task_id: plannedStages[o].task,                              task_stage_group_id:                                plannedStages[o].task_stage_group,                              task_stage_id: plannedStages[o].task_stage,                            };                            plan_tasks[i].task_stage_groups[j].task_stages.push(                              json                            );                            continue;                          }                        }                      }                    } else {                      const json = {                        employee: plannedStages[o].employee,                        end_date: plannedStages[o].end_date,                        entry: plannedStages[o].entry,                        form: plannedStages[o].form,                        is_due: plannedStages[o].is_due,                        recommended_hour: null,                        stage: plannedStages[o].stage,                        start_date: plannedStages[o].start_date,                        state: 'complete',                        task_id: plannedStages[o].task,                        task_stage_group_id: plannedStages[o].task_stage_group,                        task_stage_id: plannedStages[o].task_stage,                      };                      plan_tasks[i].task_stage_groups[j].task_stages.push(json);                      continue;                    }                  } else {                    let check = true;                    for (const n in plan_tasks[i].task_stage_groups) {                      if (                        plan_tasks[i].task_stage_groups[n]                          .task_stage_group_id ===                        plannedStages[o].task_stage_group                      ) {                        check = false;                      }                    }                    if (check) {                      const json = {                        end_date: plannedStages[o].end_date,                        entry: plannedStages[o].entry,                        form: plannedStages[o].form,                        is_due: plannedStages[o].is_due,                        stage_group: plannedStages[o].stage_group,                        start_date: plannedStages[o].start_date,                        task_id: plannedStages[o].task,                        task_stage_group_id: plannedStages[o].task_stage_group,                        task_stages: [                          {                            employee: plannedStages[o].employee,                            end_date: plannedStages[o].end_date,                            entry: plannedStages[o].entry,                            form: plannedStages[o].form,                            is_due: plannedStages[o].is_due,                            recommended_hour: null,                            stage: plannedStages[o].stage,                            start_date: plannedStages[o].start_date,                            state: plannedStages[o].state,                            task_id: plannedStages[o].task,                            task_stage_group_id:                              plannedStages[o].task_stage_group,                            task_stage_id: plannedStages[o].task_stage,                          },                        ],                      };                      plan_tasks[i].task_stage_groups.push(json);                      o = 0;                      continue;                    }                  }                }              } else {                const json = {                  end_date: plannedStages[o].end_date,                  entry: plannedStages[o].entry,                  form: plannedStages[o].form,                  is_due: plannedStages[o].is_due,                  stage_group: plannedStages[o].stage_group,                  start_date: plannedStages[o].start_date,                  task_id: plannedStages[o].task,                  task_stage_group_id: plannedStages[o].task_stage_group,                  task_stages: [                    {                      employee: plannedStages[o].employee,                      end_date: plannedStages[o].end_date,                      entry: plannedStages[o].entry,                      form: plannedStages[o].form,                      is_due: plannedStages[o].is_due,                      recommended_hour: null,                      stage: plannedStages[o].stage,                      start_date: plannedStages[o].start_date,                      state: plannedStages[o].state,                      task_id: plannedStages[o].task,                      task_stage_group_id: plannedStages[o].task_stage_group,                      task_stage_id: plannedStages[o].task_stage,                    },                  ],                };                plan_tasks[i].task_stage_groups.push(json);                o = 0;                continue;              }            }          }        }      }    },    async getWeeklyCheckPlan(urlData) {      const response = await this.$store.dispatch(        'getWeeklyCheckPlan',        urlData      );      if (response.status === 200) {        this.CIWeeklyPlanData = response.data;        if (          response.data.critical_info === undefined ||          response.data.critical_info === null        ) {          this.isNextWeekPlanCreated = false;        } else {          this.criticalInfoId = response.data.critical_info.id;          if (response.data.critical_info.json_data !== null) {            const plannedStages =              response.data.critical_info.json_data.planned_tasks;            const planningTask = response.data.plan_tasks;            const planningStages = [];            for (const i in planningTask) {              for (const j in planningTask[i].task_stage_groups) {                for (const l in planningTask[i].task_stage_groups[j]                  .task_stages) {                  planningStages.push(                    planningTask[i].task_stage_groups[j].task_stages[l]                  );                }              }            }            this.PlannedData = [];            if (response.data.critical_info.state === 'draft') {              for (const i in plannedStages) {                for (const j in planningStages) {                  if (                    plannedStages[i].task_stage ===                    planningStages[j].task_stage_id                  ) {                    this.PlannedData.push(plannedStages[i]);                  }                }              }            } else {              this.PlannedData = plannedStages;              const temp_list_task = [];              for (const i in plannedStages) {                if (!temp_list_task.includes(plannedStages[i].task)) {                  temp_list_task.push(plannedStages[i].task);                }              }              const list_task = [];              const list = [];              for (const i in this.CIWeeklyPlanData.plan_tasks) {                if (                  temp_list_task.includes(                    this.CIWeeklyPlanData.plan_tasks[i].task_id                  )                ) {                  list.push(this.CIWeeklyPlanData.plan_tasks[i]);                  list_task.push(this.CIWeeklyPlanData.plan_tasks[i].task_id);                }              }              this.CIWeeklyPlanData.plan_tasks = list;              const ids = [];              for (const i in temp_list_task) {                if (!list_task.includes(temp_list_task[i])) {                  ids.push(temp_list_task[i]);                }              }              this.getTaskInfoByIds({ ids: ids });              //////            }            this.CIWeeklyPlanData.critical_info.json_data.planned_tasks =              this.PlannedData;          }          this.isNextWeekPlanCreated = true;          this.checkStageDue();        }      } else {        delete this.dashboard.Total_planned_hour;        delete this.dashboard.Due_stages;        this.dashboard.State = {          state: 'Crucial information not found',          color: 'text-danger',        };      }    },    getWeek(data, isNextWeek = false) {      const array = data.split('-');      const year = array[0];      const week = array[1];      let date = null;      let day = 0;      const d = week * 7;      if (isNextWeek) {        date = new Date(year, 0, d + 7);      } else {        date = new Date(year, 0, d);      }      day = date.getDay();      const diff = date.getDate() - day + (day === 0 ? -6 : 1);      const first = new Date(date.setDate(diff)).getDate();      const last = first + 6;      const monday = new Date(date.setDate(first)).toUTCString();      const sunday = new Date(date.setDate(last)).toUTCString();      return this.formatDate(monday) + '/' + this.formatDate(sunday);    },    formatDate(date) {      const d = new Date(date);      let month = '' + (d.getMonth() + 1);      let day = '' + d.getDate();      const year = d.getFullYear();      if (month.length < 2) month = '0' + month;      if (day.length < 2) day = '0' + day;      return [year, month, day].join('-');    },    showHiddenDiv() {      event.target.classList.toggle('sendCI');      const hiddenDivs = document.querySelectorAll('.hidden-task-stageGroup');      hiddenDivs.forEach((field) => {        if (field.style.display === 'none') {          field.style.display = 'block';        } else {          field.style.display = 'none';        }      });    },    showMyPlan() {      event.target.classList.toggle('sendCI');      this.showMyTask = !this.showMyTask;    },    showAllTaskDetail() {      event.target.classList.toggle('sendCI');      this.detailView = !this.detailView;    },    showDueTasks() {      event.target.classList.toggle('sendCI');      this.dueTasks = !this.dueTasks;    },    prepareSendData(state) {      const tableData = this.$store.state['nextWeekPlanData'];      const jsonData = {        critical_info_id: this.criticalInfoId,        user_id: this.$store.getters.user.id,        employee: this.$route.params.id,        state,        planned_tasks: [],      };      jsonData.planned_tasks = tableData;      jsonData.total_work_hour = this.dashboard.Total_planned_hour;      const urlParam = {};      urlParam.data = jsonData;      urlParam.urlParam = this.criticalInfoId + '/';      const dueStage = this.dashboard.Due_stages.split('/');      if (jsonData.planned_tasks !== undefined) {        if (state === 'save') {          this.updateNextWeekPlan(urlParam);        } else if (dueStage[0] === dueStage[1]) {          this.updateNextWeekPlan(urlParam);        } else {          alert('Please plan on due stage!');        }      } else {        alert('Please plan time in any stage!');      }    },    saveCI() {      this.prepareSendData('save');    },    sendCI() {      this.prepareSendData('sent');    },    async approveAll() {      for (const i in this.orgDepEmployeeCIData) {        for (const j in this.criticalInfoList) {          if (this.orgDepEmployeeCIData[i].id === this.criticalInfoList[j]) {            const jsonData = this.orgDepEmployeeCIData[i].json_data;            jsonData.state = 'confirm';            const urlParam = {};            urlParam.data = jsonData;            urlParam.urlParam = this.criticalInfoList[j] + '/';            await this.updateNextWeekPlan(urlParam, i);          }        }      }    },    emitCriticalInfo(data) {      this.criticalInfoList = data;    },  },};</script><style scoped>.search-bar {  border: 0;  background-color: #f8f8fb;  color: #495057;  font-size: 14px;  line-height: 16px;}.search-bar i {  font-size: 16px;}.sendCI {  background: #1f304a;  color: white;}#toggle-left {  border-bottom-left-radius: 10px;  border-top-left-radius: 10px;}#toggle-right {  border-bottom-right-radius: 10px;  border-top-right-radius: 10px;}</style>