<template>  <div>    <router-link      class="btn"      :to="{        name: 'crucialInfo04',        params: {          weekId: $route.params.weekId,          type: $route.params.type,          id: $route.params.id,        },      }"    >      <i class="bx bx-chevron-left"></i> Буцах    </router-link>    <b-col class="mt-2" cols="12" style="min-width: 1035px">      <b-row>        <b-col cols="12">          <div class="card mini-stats-wid">            <div class="card-body">              <b-row>                <b-col class="m-0" cols="12">                  <b-row>                    <b-col class="d-flex" cols="4">                      <img                        src="https://tuss.io/tusd_images/profile/human_icon.png"                        class="rounded-circle mr-4"                        width="64"                        alt                      />                      <div class="align-self-center">                        <h5 v-if="$route.params.type === 'employee'">                          {{ firstName }}                          {{ lastName }}                        </h5>                        <h5 v-else-if="$route.params.type !== 'organization'">                          {{ department }}                        </h5>                        <h5 v-else>{{ organization }}</h5>                      </div></b-col                    >                    <b-col class="d-flex" cols="3">                      <div class="align-self-center">                        <h4 class="d-flex justify-content-center text-dark">                          ---                        </h4>                        <p>Average PPI</p>                      </div>                    </b-col>                    <b-col                      v-if="$route.params.type === 'employee'"                      class="d-flex"                      cols="3"                    >                      <img                        v-if="detailedInfo.dashboard.state === 'sent'"                        src="@/assets/images/icons/vector.png"                        class="my-auto rounded-circle mr-4"                        width="43.3"                        height="43.3"                        alt                      />                      <img                        v-else                        class="bx bxs-check-circle text-success mr-4 icons"                      />                      <div class="align-self-center">                        <p v-if="detailedInfo.dashboard.state === 'sent'">                          Илгээсэн:                        </p>                        <p v-else>Баталсан:</p>                        <p>{{ detailedInfo.dashboard.sent_date | datetime }}</p>                      </div>                    </b-col>                    <b-col v-else class="d-flex" cols="3">                      <div class="align-self-center">                        <span class="d-flex justify-content-center">                          <h4>                            {{ detailedInfo.dashboard.check_status.all }}                            /                          </h4>                          <h4>                            {{ detailedInfo.dashboard.check_status.sent }}                            /&nbsp;                          </h4>                          <h4>                            {{ detailedInfo.dashboard.check_status.confirm }}                          </h4>                        </span>                        <p>All / Sent / Confirmed</p>                      </div>                    </b-col>                    <b-col class="d-flex" cols="2">                      <i                        v-if="                          detailedInfo.dashboard.is_conclusion_abnormal === true                        "                        class="                          bx                          bxs-dislike                          text-danger                          mr-4                          icons                          align-self-center                        "                      />                      <img                        v-else                        class="                          bx                          bxs-like                          text-success                          mr-4                          icons                          align-self-center                        "                      />                      <div class="align-self-center">                        <p>Summary:</p>                        <p                          v-if="                            detailedInfo.dashboard.is_conclusion_abnormal ===                            true                          "                          class="bg-danger text-white px-1 conflictType"                        >                          Not Okay!                        </p>                        <p v-else class="bg-success text-white conflictType">                          Okay!                        </p>                      </div>                    </b-col>                  </b-row>                </b-col>              </b-row>            </div>          </div>        </b-col>      </b-row>    </b-col>    <b-col class="mt-3" cols="12" style="min-width: 1035px">      <b-row>        <b-col cols="6">          <div class="card mini-stats-wid">            <div class="card-body d-block">              <h4 class="font-weight-bold">Average Achievement Score</h4>              <b-progress                class="stage-progress mt-3"                :max="totalAchievementPoints"                show-value              >                <b-progress-bar                  :value="                    achievement_points -                    detailedInfo.dashboard.achievement_point                  "                  variant="dark"                ></b-progress-bar>                <b-progress-bar value="0" variant="danger"></b-progress-bar>                <b-progress-bar                  :value="detailedInfo.dashboard.achievement_point"                  variant="success"                ></b-progress-bar>              </b-progress>              <div class="flex-space-between mt-1">                <span class="d-flex">                  <p>/+</p>                  <p>{{ detailedInfo.dashboard.achievement_point }}</p>                  <p>&nbsp;Today/</p>                </span>                <span class="d-flex">                  <p>{{ achievement_points }}/</p>                  <p>{{ totalAchievementPoints }}</p>                </span>              </div>            </div>          </div>        </b-col>        <b-col cols="6">          <div class="card mini-stats-wid">            <div class="card-body d-block">              <h4 class="font-weight-bold">Number of Stages Completed</h4>              <b-progress                class="stage-progress mt-3"                :max="employee_checklist.dashboard.planned_task_stages"                show-value              >                <b-progress-bar                  :value="                    completedTaskStage - detailedInfo.dashboard.completed_stages                  "                  variant="dark"                ></b-progress-bar>                <b-progress-bar value="0" variant="danger"></b-progress-bar>                <b-progress-bar                  :value="detailedInfo.dashboard.completed_stages"                  variant="success"                ></b-progress-bar>              </b-progress>              <div class="flex-space-between mt-1">                <span class="d-flex">                  <p>/+</p>                  <p>{{ detailedInfo.dashboard.completed_stages }}</p>                  <p>&nbsp;Today/</p>                </span>                <span class="d-flex">                  <p>{{ completedTaskStage }}/</p>                  <p>{{ employee_checklist.dashboard.planned_task_stages }}</p>                </span>              </div>            </div>          </div>        </b-col>      </b-row>    </b-col>    <b-col class="mt-3" cols="12">      <b-row>        <b-col cols="12">          <div class="card pl-4 pr-3 pb-3 bg-white">            <h4 class="font-weight-bold">Critical information</h4>            <div              class="d-flex w-100 mt-3"              v-if="$route.params.type === 'employee'"            ></div>            <div class="d-flex mt-3" v-else>              <!--              <div class="dark-btn btn btn-secondary mr-3">Employee view</div>-->              <!--              <div class="btn btn-secondary mr-3">Conflict and problems</div>-->              <!--              <div class="btn btn-secondary mr-3">Achievments</div>-->              <!--              <div class="btn btn-secondary mr-2 ml-auto">Add Report</div>-->              <!--              <div class="dark-btn btn btn-secondary mr-2">-->              <!--                Add Critical Information-->              <!--              </div>-->              <div                v-if="canConfirm"                class="dark-btn btn btn-secondary"                @click="approveAll"              >                Confirm all              </div>            </div>            <employeeTable              v-if="$route.params.type === 'employee'"              :table-data="detailedInfo.critical_info"              class="pt-3"            />            <Table              v-else              :table-data="detailedInfo.employees"              class="pt-3"              @checked_criticalInfo="emitCriticalInfo"            />          </div>        </b-col>      </b-row>    </b-col>  </div></template><script>import Table from '@/components/crucial_information/tables/CI04PerfTable';import employeeTable from '@/components/crucial_information/tables/CI04EmployeePerfTable';export default {  name: 'CI04Perf',  components: { Table, employeeTable },  data() {    return {      detailedInfo: {        dashboard: {          state: '',          planned_task_stages: 0,          completed_stages: 0,          sent_date: '',          is_conclusion_abnormal: false,          achievement_point: 0,          check_status: { confirm: null, sent: null, all: null },        },        employees: [],        json_data: { problems: [], system_problems: [] },      },      type: null,      lastName: null,      firstName: null,      department: null,      organization: null,      employee_checklist: { dashboard: { planned_task_stages: 0 } },      completedTaskStage: 0,      achievement_points: 0,      totalAchievementPoints: 0,      canConfirm: false,      criticalInfoList: [],      dutys: [],    };  },  beforeMount() {    const departments = this.$store.getters.company.department;    if (this.permission('ach4_hm1')) {      this.canConfirm = true;    } else if (this.$route.params.type === 'department') {      for (const i in departments) {        if (          departments[i].id === parseInt(this.$route.params.id) &&          departments[i].manager__id === this.$store.getters.user.partner_id        ) {          if (this.permission('ach4_hm2')) {            this.canConfirm = true;          }        }      }    }  },  mounted() {    this.type = this.$route.params.type;    const date = this.$route.params.date;    const id = this.$route.params.id;    if (this.type === 'employee') {      const param = date + '/' + id + '/';      this.employee_daily_check_detail(param);    } else {      const param = date + '/?' + this.type + '=' + id;      this.org_dep_daily_check_detail(param);    }    const employees = this.$store.getters.company.employees;    for (const i in employees) {      if (employees[i].partner__id === parseInt(id)) {        this.lastName = employees[i].partner__last_name;        this.firstName = employees[i].partner__name;      }    }    for (const item in this.$store.getters.user.companies) {      if (this.$store.getters.user.companies[item].is_main === true) {        this.organization =          this.$store.getters.user.companies[item].organization;        this.department = this.$store.getters.user.companies[item].department;      }    }    const params = '?' + this.type + '=' + this.$route.params.id;    if (this.$route.params.type === 'employee') {      this.crucialInfoData(params);    }  },  methods: {    getDutyType(data) {      const duty_types = this.$store.getters.company.duty_type;      for (const i in duty_types) {        if (duty_types[i].id === data) {          return duty_types[i].name;        }      }    },    async dailyCheckUpdate(params, id, index) {      const sendParams = {};      sendParams.urlPath = id + '/';      sendParams.data = params;      const response = await this.$store.dispatch(        'dailyCheckUpdate',        sendParams      );      if (response.status === 200 && response.data.result) {        this.detailedInfo.employees[index].state = sendParams.data.state;      }    },    async approveAll() {      for (const i in this.detailedInfo.employees) {        for (const j in this.criticalInfoList) {          if (this.detailedInfo.employees[i].id === this.criticalInfoList[j]) {            const id = this.detailedInfo.employees[i].id;            const param = id + '/';            const response = await this.get_daily_check_create_data(param);            if (response) {              const params = response.employee_check.json_data;              params.state = 'confirm';              await this.dailyCheckUpdate(params, id, i);            }          }        }      }    },    async get_daily_check_create_data(params) {      const response = await this.$store.dispatch(        'get_daily_check_create_data',        params      );      if (response.status === 200) {        return response.data;      }    },    emitCriticalInfo(data) {      this.criticalInfoList = data;    },    async org_dep_daily_check_detail(params) {      const response = await this.$store.dispatch(        'org_dep_daily_check_detail',        params      );      if (response.status === 200) {        this.detailedInfo = response.data;        if (this.$route.params.type !== 'employee') {          this.completedTaskStage =            this.detailedInfo.dashboard.completed_stages;          this.achievement_points =            this.detailedInfo.dashboard.achievement_point;          if (this.achievement_points < 1000) {            this.totalAchievementPoints = 1000;          } else if (this.achievement_points > 1000) {            this.totalAchievementPoints = 10000;          }          this.employee_checklist.dashboard.planned_task_stages =            this.detailedInfo.dashboard.on_process_stages;        }        console.log('detailedInfo', response.data);      }    },    async employee_daily_check_detail(params) {      const response = await this.$store.dispatch(        'employee_daily_check_detail',        params      );      if (response.status === 200) {        this.detailedInfo = response.data;        if (          this.detailedInfo.json_data.problems.length > 0 &&          this.detailedInfo.json_data.confirm !== 'confirm'        ) {          for (const i in this.detailedInfo.json_data.problems) {            const json = this.detailedInfo.json_data.problems[i];            json.diagnoses = json.diagnose_types;            json.employee = parseInt(json.employee);            json.duty_type = parseInt(json.duty_type);            json.created_date = json.conflict_date;            delete json.diagnose_types;          }          this.detailedInfo.critical_info =            this.detailedInfo.json_data.problems;        }      }    },    getWeek(data) {      const array = data.split('-');      const year = array[0];      const week = array[1];      let d = 0;      if (week === 1) {        d = 1 + week * 7;      } else {        d = 1 + (week - 1) * 7;      }      let date = new Date(year, 0, d);      let day = date.getDay();      if (day !== 1 && week === 1) {        date = date.setDate(date.getDate() + ((day + (7 - date.getDay())) % 7));        day = date.getDay();      }      const diff = date.getDate() - day + (day === 0 ? -6 : 1);      const first = new Date(date.setDate(diff)).getDate();      const last = first + 4;      const firstday = new Date(date.setDate(first)).toUTCString();      const lastday = new Date(date.setDate(last)).toUTCString();      return this.formatDate(firstday) + '/' + this.formatDate(lastday);    },    formatDate(date) {      const d = new Date(date);      let month = '' + (d.getMonth() + 1);      let day = '' + d.getDate();      const year = d.getFullYear();      if (month.length < 2) month = '0' + month;      if (day.length < 2) day = '0' + day;      return [year, month, day].join('-');    },    async crucialInfoData(params) {      const weekId = this.$route.params.weekId;      const urlPath = this.getWeek(weekId);      const urlData = urlPath + '/' + params;      const response = await this.$store.dispatch(        'getCrucialInfoData',        urlData      );      if (response.status === 200) {        this.employee_checklist = response.data.employee_checklist;        const weeklyCI = this.employee_checklist.daily_check_info;        for (const i in weeklyCI) {          this.completedTaskStage += weeklyCI[i].completed_task_stages;          this.achievement_points += weeklyCI[i].achievement_points;          if (weeklyCI[i].check_date === this.$route.params.date) {            break;          }        }        if (this.achievement_points < 1000) {          this.totalAchievementPoints = 1000;        } else if (this.achievement_points > 1000) {          this.totalAchievementPoints = 10000;        }        console.log('completedTaskStage', this.completedTaskStage);      }    },  },};</script><style scoped>.conflictType {  border-radius: 20px;  text-align: center;}.icons {  font-size: 43.3px;}.dark-btn {  background: #1f304a;  border-radius: 4px;  color: white;}</style>