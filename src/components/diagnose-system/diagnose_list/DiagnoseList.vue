<template>  <div v-if="ready">    <DiagnoseHeader />    <div class="d-flex justify-content-between align-items-center w-100 mb-3">      <div class="d-flex align-items-center">        <DiagnoseFilter          :clear="filterClear"          @diagnoseFiltered="diagnoseFilter"        />      </div>    </div>    <div v-if="filterActive">      <b-alert        show        variant="primary"        dismissible        class="d-block"        @dismissed="diagnoseFilterClear"      >        Filter:        <h5 class="d-inline-block">          <b-badge v-if="filterValues.search" variant="primary" class="mr-1">            {{ filterValues.search }}          </b-badge>          <b-badge            v-if="filterValues.department"            variant="primary"            class="mr-1"          >            {{ filterValues.department }}          </b-badge>          <b-badge            v-if="filterValues.diagnose_state"            variant="primary"            class="mr-1"          >            {{ filterValues.diagnose_state }}          </b-badge>          <b-badge            v-if="filterValues.symptom_type"            variant="primary"            class="mr-1"          >            {{ filterValues.symptom_type }}          </b-badge>          <b-badge            v-if="filterValues.start_date"            variant="primary"            class="mr-1"          >            {{ filterValues.start_date }}          </b-badge>          <b-badge v-if="filterValues.end_date" variant="primary" class="mr-1">            {{ filterValues.end_date }}          </b-badge>          <span v-if="filterValues.employees">            <b-badge              v-for="(employee, index) in filterValues.employees"              :key="index"              variant="primary"              class="mr-1"            >              {{ employee }}            </b-badge>          </span>        </h5>      </b-alert>    </div>    <b-table      ref="diagnose_table"      striped      :hover="true"      :items="tableData"      :fields="tableField"      :head-variant="'dark'"      :responsive="true"    >      <template #cell(code)="data">        <div class="text-nowrap">          <router-link            :to="{              name: 'diagnose-detail',              params: { id: data.item.id },            }"            class="task-link"          >            {{ data.item.code }}          </router-link>        </div>      </template>      <template #cell(name)="data">        <router-link          :to="{            name: 'diagnose-detail',            params: { id: data.item.id },          }"          class="task-link"        >          {{ data.item.name }}        </router-link>      </template>      <!--      <template #cell(symptom)="data">-->      <!--        <router-link-->      <!--          :to="{-->      <!--            name: 'diagnose-detail',-->      <!--            params: { id: data.item.id },-->      <!--          }"-->      <!--          class="task-link"-->      <!--        >-->      <!--          {{ data.item.symptom }}-->      <!--        </router-link>-->      <!--      </template>-->      <!--      <template #cell(symptom_type)="data">-->      <!--        <router-link-->      <!--          :to="{-->      <!--            name: 'diagnose-detail',-->      <!--            params: { id: data.item.id },-->      <!--          }"-->      <!--          class="task-link"-->      <!--        >-->      <!--          {{ data.item.symptom_type | get_key_info_category }}-->      <!--        </router-link>-->      <!--      </template>-->      <template #cell(diagnose_lines)="data">        <div class="text-nowrap">          <ul class="user-list">            <li              v-for="(diagnose_line, index) in data.item.diagnosis_lines"              :key="index"            >              <b-badge v-if="diagnose_line.algorithm" variant="warning">{{                diagnose_line.algorithm | get_algorithm_code              }}</b-badge>              <b-badge v-if="diagnose_line.regulation" variant="primary">{{                diagnose_line.regulation | get_regulation_short_name              }}</b-badge>              <b-badge v-if="diagnose_line.is_tus40_diagnosis" variant="danger"                >System diagnose</b-badge              >            </li>          </ul>        </div>      </template>      <template #cell(employee)="data">        <div class="text-nowrap">          {{ data.item.employee | get_employee_info }}        </div>      </template>      <template #cell(breached_date)="data">        <div class="text-nowrap">          {{ data.item.breached_date | date }}        </div>      </template>      <template #cell(submitted_date)="data">        <div class="text-nowrap">          {{ data.item.end_date | date }}        </div>      </template>      <template #cell(state)="data">        <h5 class="d-block">          <b-badge            v-if="              data.item.task_state === 'draft' ||              data.item.task_state === 'sent'            "            variant="warning"          >            {{ data.item.state }}          </b-badge>          <b-badge v-else variant="success">            {{ data.item.state }}          </b-badge>        </h5>      </template>    </b-table>    <div class="d-flex justify-content-center mt-4">      <b-pagination        v-if="diagnoseCount > 0"        v-model="diagnosePage"        pills        :total-rows="diagnoseCount"        :per-page="50"        @change="diagnosePagination"      ></b-pagination>    </div>    <p class="text-right mb-5">Total: {{ diagnoseCount }}</p>  </div></template><script>import DiagnoseHeader from '@/components/diagnose-system/diagnose_list/DiagnoseHeader';import DiagnoseFilter from '@/components/diagnose-system/DiagnoseFilter';import axios from 'axios';import diagnose from '@/router/diagnose';export default {  name: 'DiagnoseList',  components: {    DiagnoseHeader,    DiagnoseFilter,  },  data() {    return {      ready: true,      tableData: null,      tableField: [        {          key: 'code',          label: 'Code',          sortable: true,        },        {          key: 'name',          label: 'Name',          sortable: true,        },        // {        //   key: 'symptom_type',        //   label: 'Symptom',        //   sortable: true,        // },        {          key: 'diagnose_lines',          label: 'Diagnose Lines',          sortable: false,        },        {          key: 'employee',          label: 'Employee',          sortable: true,        },        {          key: 'breached_date',          label: 'Breached Date',          sortable: true,        },        {          key: 'submitted_date',          label: 'Submitted Date',          sortable: true,        },        {          key: 'state',          label: 'Status',          sortable: true,        },        {          key: 'action',          label: 'Action',          sortable: false,        },      ],      tableSort: [        {          field: 'created_date',          direction: 'asc',        },      ],      tableParams: null,      tableUrl: null,      activeCompany: this.$store.getters.activeCompany,      searchDiagnoseName: this.$route.query.search || null,      searchDiagnoseNameActive: false,      diagnoseName: null,      diagnosePage: 1,      diagnoseData: null,      diagnoseCount: 0,      searchData: null,      diagnoseDetailActive: false,      filterActive: false,      filterClear: false,      filterValues: null,      filterLoad: false,    };  },  mounted() {    this.ready = true;    this.loadFilter();    this.tableLoad();  },  methods: {    tableLoad() {      this.diagnoseCount = 0;      const query = this.$route.query;      if (!query.is_active) {        query.is_active = '1';      }      let data = Object.entries(query);      data = data.map(        ([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`      );      const queryParam = `${this.activeCompany}/?` + data.join('&');      this.tableUrl = `/pages/diag/list_diagnoses/` + queryParam;      axios.get(this.tableUrl).then((response) => {        this.tableData = response.data.results;        this.diagnoseCount = response.data.total;      });    },    // diagnose filter    async diagnoseFilter(value) {      const query = {};      this.filterActive = true;      this.filterValues = value;      const symptomType = this.filterValues.symptom_type;      const diagnoseDepartment = this.filterValues.department;      const diagnoseState = this.filterValues.diagnose_state;      const diagnoseEmployees = this.filterValues.employees;      const startDate = this.filterValues.start_date;      const endDate = this.filterValues.end_date;      if (symptomType) {        for (const single of this.$store.getters.company.key_info_categories) {          if (single.id === parseInt(symptomType)) {            this.filterValues.symptom_type = single.name;            query.symptom_type = single.id;            break;          }        }      }      if (diagnoseDepartment) {        for (const single of this.$store.getters.company.department) {          if (single.id === parseInt(diagnoseDepartment)) {            this.filterValues.department = single.name;            query.department = single.id;            break;          }        }      }      if (diagnoseState) {        this.filterValues.state =          diagnoseState.charAt(0).toUpperCase() + diagnoseState.slice(1);        query.diagnose_state = diagnoseState;      }      if (diagnoseEmployees) {        const empList = [];        const empIds = [];        for (const one of diagnoseEmployees) {          for (const single of this.$store.getters.company.employees) {            if (single.partner__id === parseInt(one)) {              empList.push(                `${single.partner__name} ${single.partner__last_name} `              );              empIds.push(single.partner__id);            }          }        }        this.filterValues.employees = empList;        query.employees = empIds;      }      if (startDate) {        this.filterValues.start_date = startDate;        query.start_date = startDate;      }      if (endDate) {        this.filterValues.end_date = endDate;        query.end_date = endDate;      }      this.tableData = null;      this.$refs.diagnose_table.refresh();      await this.$router.replace({ query });      this.tableLoad();    },    // task filter clear    async diagnoseFilterClear() {      this.filterActive = false;      this.filterLoad = false;      this.diagnosePage = 1;      const query = {};      await this.$router.replace({ query });      this.filterClear = true;      this.tableData = null;      this.$refs.diagnose_table.refresh();      this.tableLoad();    },    loadFilter() {      const query = this.$route.query;      const activeFilter = {};      if (query.symptom_type) {        for (const single of this.$store.getters.company.key_info_categories) {          if (single.id === parseInt(query.symptom_type)) {            this.filterActive = true;            activeFilter.symptom_type = single.name;            break;          }        }      }      if (query.department) {        for (const single of this.$store.getters.company.department) {          if (single.id === parseInt(query.department)) {            this.filterActive = true;            activeFilter.department = single.name;            break;          }        }      }      if (query.diagnose_state) {        this.filterActive = true;        activeFilter.diagnose_state = query.diagnose_state;      }      if (query.employees) {        const empList = [];        for (const one of query.employees) {          for (const single of this.$store.getters.company.employees) {            if (single.partner__id === parseInt(one)) {              this.filterActive = true;              empList.push(                `${single.partner__name} ${single.partner__last_name} `              );            }          }        }        activeFilter.employees = empList;      }      if (query.start_date) {        this.filterActive = true;        activeFilter.start_date = query.start_date;      }      if (query.end_date) {        this.filterActive = true;        activeFilter.end_date = query.end_date;      }      this.filterValues = activeFilter;    },    async diagnosePagination(page) {      this.diagnosePage = page;      const query = Object.assign({}, this.$route.query);      query.page = page;      await this.$router.replace({ query });      this.tableLoad();    },  },};</script><style scoped></style>