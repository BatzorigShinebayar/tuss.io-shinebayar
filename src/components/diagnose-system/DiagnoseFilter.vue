<template>  <div>    <a class="mr-3 p-1 cursor-pointer" @click="showFilter">      <Fa :icon="['fas', 'filter']" class="mr-1" />Filter    </a>    <b-modal id="diagnose-filter" scrollable @hidden="hideFilter">      <template #modal-header="{ close }">        <p><Fa :icon="['fas', 'filter']" /> Filter</p>        <button type="button" aria-label="Close" class="close" @click="close()">          Ã—        </button>      </template>      <div class="p-2">        <b-form-group label="Diagnose name" label-for="diagnose-filter-name">          <b-form-input            id="diagnose-filter-name"            v-model="diagnoseName"          ></b-form-input>        </b-form-group>        <b-form-group          label="Symptom type"          label-for="diagnose-filter-symptom-type"        >          <treeselect            id="diagnose-filter-symptom-type"            v-model="symptomType"            :multiple="false"            :options="symptomTypeList"            :normalizer="symptomTypeNormalizer"          />        </b-form-group>        <b-form-group label="Department" label-for="selector-department">          <treeselect            id="selector-department"            v-model="diagnoseDepartment"            :multiple="false"            :options="diagnoseDepartmentList"            :normalizer="diagnoseDepartmentNormalizer"          />        </b-form-group>        <b-form-group label="Diagnose state" label-for="selector-state">          <treeselect            id="selector-state"            v-model="diagnoseState"            :multiple="false"            :options="diagnoseStateList"          />        </b-form-group>        <b-form-group          label-cols="4"          label-cols-lg="3"          label="Start date"          label-for="diagnose-filter-breached-date-start"        >          <b-form-datepicker            id="diagnose-filter-breached-date-start"            v-model="diagnoseBreachedDateStart"          ></b-form-datepicker>        </b-form-group>        <b-form-group          label-cols="4"          label-cols-lg="3"          label="End date"          label-for="diagnose-filter-breached-date-end"        >          <b-form-datepicker            id="diagnose-filter-breached-date-end"            v-model="diagnoseBreachedDateEnd"          ></b-form-datepicker>        </b-form-group>        <b-form-group          class="mb-4"          label="employee"          label-for="selector-employee"        >          <treeselect            id="selector-employee"            v-model="diagnoseEmployees"            :multiple="true"            :value-consists-of="'LEAF_PRIORITY'"            :options="diagnoseEmployeesList"          >          </treeselect>        </b-form-group>      </div>      <template #modal-footer>        <div class="w-100">          <b-button            variant="primary"            class="ml-2 float-right"            @click="searchDiagnose"          >            Filter          </b-button>          <b-button variant="light" class="float-right" @click="hideModal">            Cancel          </b-button>        </div>      </template>    </b-modal>  </div></template><script>import Treeselect from '@riophae/vue-treeselect';export default {  name: 'DiagnoseFilter',  components: {    Treeselect,  },  data() {    return {      diagnoseName: null,      symptomType: null,      diagnoseDepartment: null,      diagnoseState: null,      diagnoseBreachedDateStart: null,      diagnoseBreachedDateEnd: null,      diagnoseEmployees: null,      symptomTypeNormalizer(node) {        return {          id: node.id,          label: node.code + ' | ' + node.name,        };      },      diagnoseDepartmentNormalizer(node) {        return {          id: node.id,          label: node.short_name + ' | ' + node.name,        };      },      diagnoseStateList: [        { id: 'draft', label: 'Draft' },        { id: 'sent', label: 'Sent' },        { id: 'confirm', label: 'Confirm' },      ],    };  },  computed: {    symptomTypeList() {      const optionList = [];      for (const symptomType of this.$store.getters.company        .key_info_categories) {        if (symptomType.is_active === '1') {          optionList.push(symptomType);        }      }      return optionList;    },    diagnoseDepartmentList() {      const optionList = [];      const allDepartment = this.$store.getters.company.department;      for (const department of this.$store.getters.company.department) {        if (department.is_active === '1') {          optionList.push(department);        }      }      return optionList;    },    diagnoseEmployeesList() {      const employeeList = this.$store.getters.company.employees;      const allDepartments = this.$store.getters.company.department;      const activeDepartments = [];      for (const department of allDepartments) {        if (department.is_active === '1') {          const employees = [];          for (const emp of employeeList) {            if (emp.department__id === department.id) {              if (emp.is_active === '1') {                const employeeContext = {                  id: emp.partner__id,                  label: emp.partner__name + ' ' + emp.partner__last_name,                };                employees.push(employeeContext);              }            }          }          const departmentContext = {            id: department.id + 'dep',            label: department.name,            children: employees,          };          activeDepartments.push(departmentContext);        }      }      return activeDepartments;    },  },  methods: {    showFilter() {      this.diagnoseName = this.$route.query.search;      this.symptomType = this.$route.query.symptom_type;      this.diagnoseDepartment = this.$route.query.department;      this.diagnoseState = this.$route.query.state;      this.diagnoseBreachedDateStart = this.$route.query.start_date;      this.diagnoseBreachedDateEnd = this.$route.query.end_date;      const employees = this.$route.query.employees;      if (employees) {        this.diagnoseEmployees = employees          .split(',')          .map((emp) => parseInt(emp));      }      this.$root.$emit('bv::show::modal', 'diagnose-filter');    },    hideFilter() {      this.diagnoseName = null;      this.symptomType = null;      this.diagnoseDepartment = null;      this.diagnoseState = null;      this.diagnoseEmployees = null;      this.diagnoseBreachedDateStart = null;      this.diagnoseBreachedDateEnd = null;    },    hideModal() {      this.$root.$emit('bv::hide::modal', 'diagnose-filter');    },    async searchDiagnose() {      this.hideModal();      const query = {};      if (this.diagnoseName) {        query.search = this.diagnoseName;      }      if (this.symptomType) {        query.symptom_type = this.symptomType;      }      if (this.diagnoseDepartment) {        query.department = this.diagnoseDepartment;      }      if (this.diagnoseState) {        query.state = this.diagnoseState;      }      if (this.diagnoseBreachedDateStart) {        query.start_date = this.diagnoseBreachedDateStart;      }      if (this.diagnoseBreachedDateEnd) {        query.end_date = this.diagnoseBreachedDateEnd;      }      if (this.diagnoseEmployees) {        query.employees = this.diagnoseEmployees.join();      }      await this.$router.replace({ query });      this.$emit('reload', true);    },  },};</script>