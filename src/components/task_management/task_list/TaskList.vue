<template>  <div v-if="ready">    <TaskHeader />    <div class="d-flex justify-content-between align-items-center w-100 mb-3">      <div class="d-flex align-items-center">        <div class="mr-3">          <b-form-select            v-model="taskYear"            class="task_year"            :options="taskYearList"            @change="changeYear"          >          </b-form-select>        </div>        <TaskFilter :clear="filterClear" @taskFiltered="taskFilter" />        <div class="mr-3">          <b-input-group            label="Task name"            label-for="company_select"            class="search-form"          >            <template #append>              <b-input-group-text @click="searchName">                <Fa :icon="['fas', 'search']" />              </b-input-group-text>            </template>            <b-form-input              id="search-task"              placeholder="Task name"              v-model="searchTaskName"              @keydown.native="searchEnterHandler"            ></b-form-input>          </b-input-group>        </div>        <div class="mr-3">          <export-excel            class="btn btn-default"            :data="tableData"            :fields="jsonFields"            worksheet="My Worksheet"            name="filename.xls"          >            Download Excel          </export-excel>        </div>      </div>      <div class="d-flex align-items-center">        <b-button v-b-toggle.task-create variant="deep-blue">          <Fa :icon="['fas', 'plus']" />          Create task        </b-button>      </div>    </div>    <div v-if="searchTaskNameActive">      <b-alert        show        variant="primary"        dismissible        class="d-inline-block"        @dismissed="searchNameClear"      >        Search result:        <strong>{{ searchTaskNameActive }}</strong>      </b-alert>    </div>    <div v-if="filterActive">      <b-alert        show        variant="primary"        dismissible        class="d-block"        @dismissed="taskFilterClear"      >        Filter:        <h5 class="d-inline-block">          <b-badge v-if="filterValues.search" variant="primary" class="mr-1">            {{ filterValues.search }}          </b-badge>          <b-badge            v-if="filterValues.sub_function_id"            variant="primary"            class="mr-1"          >            {{ filterValues.sub_function_id }}          </b-badge>          <b-badge            v-if="filterValues.department_id"            variant="primary"            class="mr-1"          >            {{ filterValues.department_id }}          </b-badge>          <b-badge v-if="filterValues.algorithm" variant="primary" class="mr-1">            {{ filterValues.algorithm }}          </b-badge>          <b-badge            v-if="filterValues.task_state"            variant="primary"            class="mr-1"          >            {{ filterValues.task_state }}          </b-badge>          <b-badge v-if="filterValues.task_type" variant="primary" class="mr-1">            {{ filterValues.task_type }}          </b-badge>          <b-badge            v-if="filterValues.start_date"            variant="primary"            class="mr-1"          >            {{ filterValues.start_date }}          </b-badge>          <b-badge v-if="filterValues.end_date" variant="primary" class="mr-1">            {{ filterValues.end_date }}          </b-badge>          <span v-if="filterValues.executing_employee">            <b-badge              v-for="(executor, index) in filterValues.executing_employee"              :key="index"              variant="primary"              class="mr-1"            >              {{ executor }}            </b-badge>          </span>        </h5>      </b-alert>    </div>    <p class="font-weight-bold mb-3">Total task: {{ taskCount }}</p>    <b-table      ref="task_table"      striped      :hover="true"      :items="tableData"      :fields="tableField"      :responsive="true"    >      <template #cell(code)="data">        <div class="text-nowrap">          {{ data.item.code }}        </div>      </template>      <template #cell(name)="data">        <router-link          :to="{            name: 'task-detail',            query: { id: data.item.id, page: $route.query.page },          }"          class="task-link"        >          {{ data.item.name }}        </router-link>      </template>      <template #cell(executing_employee)="data">        <div class="text-nowrap">          {{ data.item.executing_employee | employee(emps) }}        </div>      </template>      <template #cell(start_date)="data">        <div class="text-nowrap">          {{ data.item.start_date }}        </div>      </template>      <template #cell(end_date)="data">        <div class="text-nowrap">          {{ data.item.end_date }}        </div>      </template>      <template #cell(task_state)="data">        <h5 class="d-block">          <b-badge            v-if="              data.item.task_state === 'draft' ||              data.item.task_state === 'sent'            "            variant="warning"          >            {{ data.item.task_state }}          </b-badge>          <b-badge v-else variant="success">            {{ data.item.task_state }}          </b-badge>        </h5>      </template>    </b-table>    <div class="d-flex justify-content-center mt-4">      <b-pagination        v-if="taskCount > 0"        v-model="taskPage"        pills        :total-rows="taskCount"        :per-page="50"        @change="taskPagination"      ></b-pagination>    </div>    <TaskCreate />  </div></template><script>import TaskHeader from '@/components/task_management/task_list/TaskHeader';import TaskFilter from '@/components/task_management/task_list/TaskFilter';import TaskCreate from '@/components/task_management/task_list/create/TaskCreate';import axios from 'axios';export default {  name: 'AllTask',  components: {    TaskHeader,    TaskFilter,    TaskCreate,  },  filters: {    employee(value, emps) {      for (const emp of emps) {        if (emp.partner__id === value) {          value = emp.partner__name + ' ' + emp.partner__last_name;        }      }      return value;    },  },  data() {    return {      ready: false,      taskYear: null,      taskYearList: [        { value: 2020, text: '2020' },        { value: 2021, text: '2021' },        { value: 2022, text: '2022' },        { value: 2023, text: '2023' },        { value: 2024, text: '2024' },      ],      tableData: null,      tableField: [        {          key: 'code',          label: 'Code',          sortable: true,        },        {          key: 'name',          label: 'Task name',          sortable: true,        },        {          key: 'executing_employee',          label: 'Employee',          sortable: true,        },        {          key: 'start_date',          label: 'Start date',          sortable: true,        },        {          key: 'end_date',          label: 'End date',          sortable: true,        },        {          key: 'task_state',          label: 'Status',          sortable: true,        },      ],      jsonFields: {        'Task code': 'code',        'Task name': 'name',        'Start date': 'start_date',        'End date': 'end_date',      },      tableSort: [        {          field: 'end_date',          direction: 'asc',        },      ],      tableParams: null,      emps: this.$store.getters.company.employees,      activeCompany: this.$store.getters.activeCompany,      searchTaskName: this.$route.query.search || null,      searchTaskNameActive: false,      taskName: null,      taskPage: 1,      taskData: null,      taskCount: 0,      searchData: null,      taskDetailActive: false,      filterActive: false,      filterClear: false,      filterValues: null,      filterLoad: false,    };  },  async created() {    // task year    let year = this.$route.query.year;    if (!year) {      year = new Date().getFullYear();      this.taskYear = year;      const query = {        ...this.$route.query,        year,      };      await this.$router.replace({ query });    } else {      this.taskYear = year;    }    // organization    let organization = this.$route.query.organization;    if (!organization) {      organization = this.activeCompany;      const query = {        ...this.$route.query,        organization,      };      await this.$router.replace({ query });    }  },  mounted() {    // ready to render child components    this.ready = true;    this.loadFilter();    this.tableLoad();  },  methods: {    // load table data    tableLoad() {      this.taskCount = 0;      const query = this.$route.query;      if (!query.is_active) {        query.is_active = '1';      }      query.ordering = '-created_date';      const url = `/pages/plan/list_task_stat/${this.activeCompany}/${this.taskYear}/`;      axios.get(url, { params: query }).then((response) => {        this.tableData = response.data.results;        this.taskCount = response.data.total;      });    },    // table pagination    async taskPagination(page) {      this.taskPage = page;      const query = Object.assign({}, this.$route.query);      query.page = page;      await this.$router.replace({ query });      this.tableLoad();    },    // change task year    async changeYear() {      const query = {        ...this.$route.query,        year: this.taskYear,      };      await this.$router.replace({ query });      this.tableLoad();    },    // task name search    async searchName() {      if (!this.searchTaskName) {        return;      }      this.searchTaskNameActive = this.searchTaskName;      const query = Object.assign({}, this.$route.query);      query.search = this.searchTaskName;      query.page = '1';      this.taskPage = 1;      this.tableData = null;      this.$refs.task_table.refresh();      await this.$router.replace({ query });      await this.tableLoad();    },    //search input enter button    searchEnterHandler(event) {      if (event.which === 13) {        this.searchName();      }    },    // task name search clear    async searchNameClear() {      this.searchTaskNameActive = false;      this.searchTaskName = null;      const query = Object.assign({}, this.$route.query);      delete query.search;      query.page = '1';      this.taskPage = 1;      this.tableData = null;      this.$refs.task_table.refresh();      await this.$router.replace({ query });      await this.tableLoad();    },    // task filter    async taskFilter(value) {      const query = {        year: this.$route.query.year,        organization: this.$route.query.organization,      };      this.filterActive = true;      this.filterValues = value;      const taskType = this.filterValues.task_type;      const taskFunction = this.filterValues.sub_function_id;      const taskDepartment = this.filterValues.department_id;      const taskAlgorithm = this.filterValues.algorithm;      const taskState = this.filterValues.task_state;      const taskEmployees = this.filterValues.executing_employee;      const startDate = this.filterValues.start_date;      const endDate = this.filterValues.end_date;      if (taskType) {        for (const single of this.$store.getters.company.task_type) {          if (single.id === parseInt(taskType)) {            this.filterValues.task_type = single.name;            query.task_type = single.id;            break;          }        }      }      if (taskFunction) {        for (const childFunction of this.$store.getters.company.function) {          for (const subFunction of childFunction.sub_function) {            if (subFunction.id === parseInt(taskFunction)) {              this.filterValues.sub_function_id = subFunction.name;              query.sub_function_id = subFunction.id;              break;            }          }        }      }      if (taskDepartment) {        for (const single of this.$store.getters.company.department) {          if (single.id === parseInt(taskDepartment)) {            this.filterValues.department_id = single.name;            query.department_id = single.id;            break;          }        }      }      if (taskAlgorithm) {        for (const single of this.$store.getters.company.algorithm) {          if (single.id === parseInt(taskAlgorithm)) {            this.filterValues.algorithm = single.name;            query.algorithm = single.id;            break;          }        }      }      if (taskState) {        this.filterValues.task_state =          taskState.charAt(0).toUpperCase() + taskState.slice(1);        query.task_state = taskState;      }      if (taskEmployees) {        const empList = [];        const empIds = [];        for (const one of taskEmployees          .split(',')          .map((emp) => parseInt(emp))) {          for (const single of this.$store.getters.company.employees) {            if (single.partner__id === parseInt(one)) {              empList.push(                `${single.partner__name} ${single.partner__last_name} `              );              empIds.push(single.partner__id);            }          }        }        this.filterValues.executing_employee = empList;        query.executing_employee = empIds.join();      }      if (startDate) {        this.filterValues.start_date = startDate;        query.start_date = startDate;      }      if (endDate) {        this.filterValues.end_date = endDate;        query.end_date = endDate;      }      this.tableData = null;      this.$refs.task_table.refresh();      await this.$router.replace({ query });      this.tableLoad();    },    // task filter clear    async taskFilterClear() {      this.filterActive = false;      this.filterLoad = false;      this.taskPage = 1;      const query = {        year: this.$route.query.year,        organization: this.$route.query.organization,      };      await this.$router.replace({ query });      this.filterClear = true;      this.tableData = null;      this.$refs.task_table.refresh();      this.tableLoad();    },    loadFilter() {      const query = this.$route.query;      const activeFilter = {};      if (query.task_type) {        for (const single of this.$store.getters.company.task_type) {          if (single.id === parseInt(query.task_type)) {            this.filterActive = true;            activeFilter.task_type = single.name;            break;          }        }      }      if (query.sub_function_id) {        for (const childFunction of this.$store.getters.company.function) {          for (const subFunction of childFunction.sub_function) {            if (subFunction.id === parseInt(query.sub_function_id)) {              this.filterActive = true;              activeFilter.sub_function_id = subFunction.name;              break;            }          }        }      }      if (query.department_id) {        for (const single of this.$store.getters.company.department) {          if (single.id === parseInt(query.department_id)) {            this.filterActive = true;            activeFilter.department_id = single.name;            break;          }        }      }      if (query.algorithm) {        for (const single of this.$store.getters.company.algorithm) {          if (single.id === parseInt(query.algorithm)) {            this.filterActive = true;            activeFilter.algorithm = single.name;            break;          }        }      }      if (query.task_state) {        this.filterActive = true;        activeFilter.task_type = query.task_state;      }      if (query.executing_employee) {        const empList = [];        for (const one of query.executing_employee          .split(',')          .map((emp) => parseInt(emp))) {          for (const single of this.$store.getters.company.employees) {            if (single.partner__id === parseInt(one)) {              this.filterActive = true;              empList.push(                `${single.partner__name} ${single.partner__last_name} `              );            }          }        }        activeFilter.executing_employee = empList;      }      if (query.start_date) {        this.filterActive = true;        activeFilter.start_date = query.start_date;      }      if (query.end_date) {        this.filterActive = true;        activeFilter.end_date = query.end_date;      }      this.filterValues = activeFilter;    },  },};</script>