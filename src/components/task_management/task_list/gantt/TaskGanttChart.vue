<template>  <div v-if="ready">    <div class="d-flex justify-content-between align-items-center w-100 mb-3">      <div class="d-flex align-items-center">        <div class="mr-3">          <b-form-select            v-model="taskYear"            class="task_year"            :options="taskYearList"            @change="changeYear"          >          </b-form-select>        </div>        <TaskFilter :clear="filterClear" @taskFiltered="taskFilter" />        <div class="mr-3">          <b-input-group            label="Task name"            label-for="company_select"            class="search-form"          >            <template #append>              <b-input-group-text @click="searchName">                <Fa :icon="['fas', 'search']" />              </b-input-group-text>            </template>            <b-form-input              id="search-task"              placeholder="Task name"              v-model="searchTaskName"              @keydown.native="searchEnterHandler"            ></b-form-input>          </b-input-group>        </div>      </div>    </div>    <div v-if="searchTaskNameActive">      <b-alert        show        variant="primary"        dismissible        class="d-inline-block"        @dismissed="searchNameClear"      >        Search result:        <strong>{{ searchTaskNameActive }}</strong>      </b-alert>    </div>    <div v-if="filterActive">      <b-alert        show        variant="primary"        dismissible        class="d-block"        @dismissed="taskFilterClear"      >        Filter:        <h5 class="d-inline-block">          <b-badge v-if="filterValues.search" variant="primary" class="mr-1">            {{ filterValues.search }}          </b-badge>          <b-badge            v-if="filterValues.sub_function_id"            variant="primary"            class="mr-1"          >            {{ filterValues.sub_function_id }}          </b-badge>          <b-badge            v-if="filterValues.department_id"            variant="primary"            class="mr-1"          >            {{ filterValues.department_id }}          </b-badge>          <b-badge v-if="filterValues.algorithm" variant="primary" class="mr-1">            {{ filterValues.algorithm }}          </b-badge>          <b-badge            v-if="filterValues.task_state"            variant="primary"            class="mr-1"          >            {{ filterValues.task_state }}          </b-badge>          <b-badge v-if="filterValues.task_type" variant="primary" class="mr-1">            {{ filterValues.task_type }}          </b-badge>          <b-badge            v-if="filterValues.start_date"            variant="primary"            class="mr-1"          >            {{ filterValues.start_date }}          </b-badge>          <b-badge v-if="filterValues.end_date" variant="primary" class="mr-1">            {{ filterValues.end_date }}          </b-badge>          <span v-if="filterValues.executor">            <b-badge              v-for="(executor, index) in filterValues.executor"              :key="index"              variant="primary"              class="mr-1"            >              {{ executor }}            </b-badge>          </span>        </h5>      </b-alert>    </div>    <p class="font-weight-bold mb-3">Total task: {{ taskCount }}</p>    <div>      <ejs-gantt        ref="gantt"        id="GanttContainer"        :dataSource="taskGanttData"        :height="height"        :taskFields="taskFields"        :columns="columns"        :treeColumnIndex="1"        :allowSelection="true"        :gridLines="gridLines"        :highlightWeekends="true"        :labelSettings="labelSettings"        :includeWeekend="true"        :resources="employees"        :rowHeight="46"      >      </ejs-gantt>    </div>    <div class="d-flex justify-content-center mt-4">      <b-pagination        v-if="taskCount > 0"        v-model="taskPage"        pills        :total-rows="taskCount"        :per-page="50"        @change="taskPagination"      ></b-pagination>    </div>  </div></template><script>import { Selection, DayMarkers } from '@syncfusion/ej2-vue-gantt';import axios from 'axios';import TaskFilter from '@/components/task_management/task_list/TaskFilter';export default {  name: 'TaskGanttChart',  components: {    TaskFilter,  },  data() {    return {      taskGanttData: null,      height: '450px',      taskFields: {        id: 'id',        name: 'name',        startDate: 'start_date',        endDate: 'end_date',        progress: 'progress',        duration: 'duration',        resourceInfo: 'resources',        child: 'task_stage_groups',      },      columns: [        { field: 'id', visible: false },        {          field: 'name',          headerText: 'Name',          width: '250',          clipMode: 'EllipsisWithTooltip',        },        { field: 'start_date', headerText: 'Start Date' },        { field: 'end_date', headerText: 'End Date' },        { field: 'duration', headerText: 'Duration' },      ],      gridLines: 'Both',      labelSettings: {        leftLabel: 'name',        rightLabel: 'resourceInfo',      },      resourceFields: {        id: 'partner__id',        name: 'partner__name',        group: 'department__short_name',      },      employees: this.$store.getters.company.employees,      ready: false,      taskYear: null,      taskYearList: [        { value: 2020, text: '2020' },        { value: 2021, text: '2021' },        { value: 2022, text: '2022' },        { value: 2023, text: '2023' },        { value: 2024, text: '2024' },      ],      activeCompany: this.$store.getters.activeCompany,      searchTaskName: this.$route.query.search || null,      searchTaskNameActive: false,      taskCount: 0,      searchData: null,      filterActive: false,      filterClear: false,      filterValues: null,      filterLoad: false,    };  },  async created() {    // task year    let year = this.$route.query.plan_year;    if (!year) {      year = new Date().getFullYear();      this.taskYear = year;      const query = {        ...this.$route.query,        plan_year: year,      };      await this.$router.replace({ query });    } else {      this.taskYear = year;    }    // organization    let organization = this.$route.query.organization;    if (!organization) {      organization = this.activeCompany;      const query = {        ...this.$route.query,        organization,      };      await this.$router.replace({ query });    }  },  mounted() {    this.ready = true;    this.loadFilter();    this.taskGanttLoad();  },  methods: {    // load table data    taskGanttLoad() {      this.taskCount = 0;      const query = this.$route.query;      if (!query.is_active) {        query.is_active = '1';      }      let data = Object.entries(query);      data = data.map(        ([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`      );      const queryParam = data.join('&');      this.tableUrl =        `/pages/plan/gantt_chart_task/${this.activeCompany}/?` + queryParam;      axios.get(this.tableUrl).then((response) => {        let task_list = [];        let algorithm_info;        for (const task_info of response.data.results) {          for (const algorithm of this.$store.getters.company.algorithm) {            if (algorithm.id === task_info.algorithm) {              algorithm_info = algorithm;            }          }          for (const task_stage_group of task_info.task_stage_groups) {            for (const stage_group of algorithm_info.stage_groups) {              if (stage_group.id === task_stage_group.stage_group) {                task_stage_group.name =                  stage_group.code + ' - ' + stage_group.name;              }            }          }          task_info.algorithm = algorithm_info.name;          task_list.push(task_info);        }        // this.taskGanttData = { Items: task_list };        this.taskGanttData = task_list;        this.taskCount = response.data.total;      });    },    // table pagination    async taskPagination(page) {      this.taskPage = page;      const query = Object.assign({}, this.$route.query);      query.page = page;      await this.$router.replace({ query });      this.taskGanttLoad();    },    // change task year    async changeYear() {      const query = {        ...this.$route.query,        plan_year: this.taskYear,      };      await this.$router.replace({ query });      this.taskGanttLoad();    },    // task name search    async searchName() {      if (!this.searchTaskName) {        return;      }      this.searchTaskNameActive = this.searchTaskName;      const query = Object.assign({}, this.$route.query);      query.search = this.searchTaskName;      query.page = '1';      this.taskPage = 1;      this.tableData = null;      this.$refs.task_table.refresh();      await this.$router.replace({ query });      await this.taskGanttLoad();    },    //search input enter button    searchEnterHandler(event) {      if (event.which === 13) {        this.searchName();      }    },    // task name search clear    async searchNameClear() {      this.searchTaskNameActive = false;      this.searchTaskName = null;      const query = Object.assign({}, this.$route.query);      delete query.search;      query.page = '1';      this.taskPage = 1;      this.tableData = null;      this.$refs.task_table.refresh();      await this.$router.replace({ query });      await this.taskGanttLoad();    },    // task filter    async taskFilter(value) {      const query = {        plan_year: this.$route.query.plan_year,        organization: this.$route.query.organization,      };      this.filterActive = true;      this.filterValues = value;      const taskType = this.filterValues.task_type;      const taskFunction = this.filterValues.sub_function_id;      const taskDepartment = this.filterValues.department_id;      const taskAlgorithm = this.filterValues.algorithm;      const taskState = this.filterValues.task_state;      const taskEmployees = this.filterValues.executor;      const startDate = this.filterValues.start_date;      const endDate = this.filterValues.end_date;      if (taskType) {        for (const single of this.$store.getters.company.task_type) {          if (single.id === parseInt(taskType)) {            this.filterValues.task_type = single.name;            query.task_type = single.id;            break;          }        }      }      if (taskFunction) {        for (const childFunction of this.$store.getters.company.function) {          for (const subFunction of childFunction.sub_function) {            if (subFunction.id === parseInt(taskFunction)) {              this.filterValues.sub_function_id = subFunction.name;              query.sub_function_id = subFunction.id;              break;            }          }        }      }      if (taskDepartment) {        for (const single of this.$store.getters.company.department) {          if (single.id === parseInt(taskDepartment)) {            this.filterValues.department_id = single.name;            query.department_id = single.id;            break;          }        }      }      if (taskAlgorithm) {        for (const single of this.$store.getters.company.algorithm) {          if (single.id === parseInt(taskAlgorithm)) {            this.filterValues.algorithm = single.name;            query.algorithm = single.id;            break;          }        }      }      if (taskState) {        this.filterValues.task_state =          taskState.charAt(0).toUpperCase() + taskState.slice(1);        query.task_state = taskState;      }      if (taskEmployees) {        const empList = [];        const empIds = [];        for (const one of taskEmployees) {          for (const single of this.$store.getters.company.employees) {            if (single.partner__id === parseInt(one)) {              empList.push(                `${single.partner__name} ${single.partner__last_name} `              );              empIds.push(single.partner__id);            }          }        }        this.filterValues.executor = empList;        query.executing_employee = empIds;      }      if (startDate) {        this.filterValues.start_date = startDate;        query.start_date = startDate;      }      if (endDate) {        this.filterValues.end_date = endDate;        query.end_date = endDate;      }      this.taskGanttData = null;      await this.$router.replace({ query });      this.taskGanttLoad();    },    // task filter clear    async taskFilterClear() {      this.filterActive = false;      this.filterLoad = false;      this.taskPage = 1;      const query = {        plan_year: this.$route.query.plan_year,        organization: this.$route.query.organization,      };      await this.$router.replace({ query });      this.filterClear = true;      this.taskGanttData = null;      this.taskGanttLoad();    },    loadFilter() {      const query = this.$route.query;      const activeFilter = {};      if (query.task_type) {        for (const single of this.$store.getters.company.task_type) {          if (single.id === parseInt(query.task_type)) {            this.filterActive = true;            activeFilter.task_type = single.name;            break;          }        }      }      if (query.sub_function_id) {        for (const childFunction of this.$store.getters.company.function) {          for (const subFunction of childFunction.sub_function) {            if (subFunction.id === parseInt(query.sub_function_id)) {              this.filterActive = true;              activeFilter.sub_function_id = subFunction.name;              break;            }          }        }      }      if (query.department_id) {        for (const single of this.$store.getters.company.department) {          if (single.id === parseInt(query.department_id)) {            this.filterActive = true;            activeFilter.department_id = single.name;            break;          }        }      }      if (query.algorithm) {        for (const single of this.$store.getters.company.algorithm) {          if (single.id === parseInt(query.algorithm)) {            this.filterActive = true;            activeFilter.algorithm = single.name;            break;          }        }      }      if (query.task_state) {        this.filterActive = true;        activeFilter.task_type = query.task_state;      }      if (query.executing_employee) {        const empList = [];        for (const one of query.executing_employee) {          for (const single of this.$store.getters.company.employees) {            if (single.partner__id === parseInt(one)) {              this.filterActive = true;              empList.push(                `${single.partner__name} ${single.partner__last_name} `              );            }          }        }        activeFilter.executor = empList;      }      if (query.start_date) {        this.filterActive = true;        activeFilter.start_date = query.start_date;      }      if (query.end_date) {        this.filterActive = true;        activeFilter.end_date = query.end_date;      }      this.filterValues = activeFilter;    },  },  provide: {    gantt: [Selection, DayMarkers],  },};</script><style>@import '../../../../../node_modules/@syncfusion/ej2-base/styles/material.css';@import '../../../../../node_modules/@syncfusion/ej2-buttons/styles/material.css';@import '../../../../../node_modules/@syncfusion/ej2-calendars/styles/material.css';@import '../../../../../node_modules/@syncfusion/ej2-dropdowns/styles/material.css';@import '../../../../../node_modules/@syncfusion/ej2-inputs/styles/material.css';@import '../../../../../node_modules/@syncfusion/ej2-navigations/styles/material.css';@import '../../../../../node_modules/@syncfusion/ej2-lists/styles/material.css';@import '../../../../../node_modules/@syncfusion/ej2-layouts/styles/material.css';@import '../../../../../node_modules/@syncfusion/ej2-popups/styles/material.css';@import '../../../../../node_modules/@syncfusion/ej2-splitbuttons/styles/material.css';@import '../../../../../node_modules/@syncfusion/ej2-grids/styles/material.css';@import '../../../../../node_modules/@syncfusion/ej2-richtexteditor/styles/material.css';@import '../../../../../node_modules/@syncfusion/ej2-treegrid/styles/material.css';@import '../../../../../node_modules/@syncfusion/ej2-vue-gantt/styles/material.css';</style>