<template>  <div class="mt-4">    <div class="d-flex justify-content-between mb-3">      <div class="d-flex align-items-center">        <h5 class="font-weight-bold mt-1 pr-2">Task Status:</h5>        <h4>          <b-badge            v-if="taskState === 'confirm' || taskState === 'finish'"            variant="success"            class="text-white"          >            {{ taskState }}          </b-badge>          <b-badge v-else variant="warning" class="text-white">            {{ taskState }}          </b-badge>        </h4>      </div>      <div>        <b-button          v-if="taskEditPermission"          variant="deep-blue"          class="ml-3"          @click="taskEdit"        >          <Fa :icon="['far', 'edit']" /> Edit        </b-button>        <b-button          v-if="taskConfirmPermission"          variant="success"          class="ml-3"          @click="confirmModalShow"          :disabled="taskConfirmButtonDisabled"        >          <Fa :icon="['far', 'check-circle']" /> Confirm        </b-button>        <b-button          v-if="taskState === 'confirm' && state !== 'complete'"          v-b-toggle.taskConf-create          variant="deep-blue"          class="ml-3"        >          <Fa :icon="['far', 'edit']" /> Task configuration        </b-button>      </div>    </div>    <div class="lined-card p-4">      <div class="row">        <div class="col-lg-6">          <div class="d-flex">            <div>              <p class="text-black-50 mb-1">Task name:</p>              <p class="font-weight-bold">                {{ taskDetail.code }} {{ taskDetail.name }}              </p>            </div>          </div>        </div>        <div class="col-lg-3">          <p class="text-black-50 mb-1">Task executor</p>          <div class="d-flex align-items-center">            <img              :src="taskDetail.executing_employee.id | get_employee_pict"              onError="this.onerror=null;this.src='https://tuss.io/tusd_images/profile/human_icon.png';"              class="border-white rounded-circle con-vs-avatar mr-1"              width="30px"              height="30px"              alt            />            <p class="font-weight-bold">              {{ taskDetail.executing_employee.name }}              {{ taskDetail.executing_employee.last_name }}            </p>          </div>        </div>        <div class="col-lg-3 d-flex">          <div>            <p class="text-black-50 mb-1">Task team</p>            <div class="d-flex">              <ul class="user-list p-0 mt-2">                <li v-for="(item, index) in taskTeams" :key="index">                  <img                    :src="item.team_member | get_employee_pict"                    onError="this.onerror=null;this.src='https://tuss.io/tusd_images/profile/human_icon.png';"                    class="border-white rounded-circle con-vs-avatar -m-1"                    v-b-tooltip.hover                    :id="'tooltip_img_' + index"                    :alt="item.name"                  />                  <b-tooltip :target="'tooltip_img_' + index">                    {{ item.team_member | get_employee_info }}                  </b-tooltip>                </li>                <li>                  <Fa                    v-if="taskState === 'confirm' && state !== 'complete'"                    :icon="['fas', 'plus-circle']"                    v-b-modal.add-task-team-member                    class="                      border-white                      rounded-circle                      con-vs-avatar                      -m-1                      text-warning                      cursor-pointer                    "                  />                </li>              </ul>            </div>          </div>          <div class="ml-auto my-auto">            <a              v-b-toggle.task-detail-collapse              class="cursor-pointer text-primary mr-3 mt-2"            >              <Fa                v-if="rotation === 0"                :icon="['fas', 'caret-circle-down']"                size="2x"                class="text-deep-blue"                @click="detailCollapse"              />              <Fa                v-else                :icon="['fas', 'caret-circle-up']"                size="2x"                class="text-deep-blue"                @click="detailCollapse"              />            </a>          </div>        </div>      </div>      <b-collapse id="task-detail-collapse">        <hr />        <div class="row">          <div class="col-lg-7">            <p class="mb-2">              Department:              <strong>{{ taskDetail.department_id.name }}</strong>            </p>            <p class="mb-2">              Task Origin:              <strong>                {{ taskDetail.task_type | get_task_type_full_name }}              </strong>            </p>            <div class="d-flex align-items-center mb-2">              <p class="mr-2">Function:</p>              <h5>                <b-badge                  v-b-tooltip.hover                  variant="primary"                  :title="taskDetail.sub_function_id.name"                >                  {{ taskDetail.sub_function_id.code }}                </b-badge>              </h5>            </div>            <p class="mb-2" v-if="is_repeated">              Type:              <strong>Repeated task</strong>            </p>            <p class="mb-2" v-else>              Type:              <strong>Non repeating task</strong>            </p>            <p class="mb-2">              Task date:              <strong>                {{ taskDetail.start_date }} / {{ taskDetail.end_date }}              </strong>            </p>            <p class="mb-2">              Algorithm:              <strong>                {{ taskDetail.algorithm.code }} -                {{ taskDetail.algorithm.name }}              </strong>            </p>          </div>          <div class="col-lg-5">            <p class="mb-2">              Is regulated:              <strong>{{ taskDetail.is_regulated ? 'Yes' : 'No' }}</strong>            </p>            <p class="mb-2">              Is conflicted:              <strong>{{ taskDetail.is_conflicted ? 'Yes' : 'No' }}</strong>            </p>            <p class="mb-2" v-if="createdEmployee">              Created by:              <strong>{{ createdEmployee }}</strong>            </p>            <p class="mb-2">              Created date:              <strong>{{ createdDate }}</strong>            </p>            <p class="mb-2" v-if="updatedEmployee">              Updated by:              <strong>{{ updatedEmployee }}</strong>            </p>            <p class="mb-2">              Updated date:              <strong>{{ updatedDate }}</strong>            </p>            <p class="mb-2" v-if="confirmDate">              Confirm date:              <strong>{{ confirmDate }}</strong>            </p>          </div>        </div>      </b-collapse>    </div>    <StageGroupTable      v-if="taskStageGroup"      :stage="taskStageGroup"      :algorithm="algorithm"      :use_perform_task="true"    />    <TaskEdit v-if="jsonData" :json="jsonData" />    <TaskConfigurationCreate :task="taskDetail" />    <b-modal      id="add-task-team-member"      ref="add-task-team-member"      title="Add Task Team Member"    >      <b-col class="d-flex mb-2" cols="12">        <b-form-group label="Choose new task member" label-for="task_member">          <treeselect            id="task_member"            v-model="addingTaskTeamMember"            :options="employees"            @select="changeTaskTeamMember"            placeholder="- choose -"          ></treeselect>        </b-form-group>      </b-col>      <b-col class="d-flex mb-2" cols="12">        <p class="modal-text mr-2">Department:</p>        <b class="modal-text">          {{ modalData.department | get_department_full_name }}        </b>      </b-col>      <template #modal-footer="{ cancel }">        <div class="w-100">          <b-button            variant="dark"            class="ml-2 float-right"            @click="addTaskTeam"          >            Add          </b-button>          <b-button class="float-right" @click="cancel()"> Cancel </b-button>        </div>      </template>    </b-modal>    <b-modal id="task-box" ref="message" centered>      <p>{{ messageText }}</p>      <template #modal-footer="{ ok }">        <b-button          variant="primary"          class="justify-content-center pr-5 pl-5 mb-3"          @click="ok()"          >OK        </b-button>      </template>    </b-modal>    <b-modal id="task-confirm-modal" title="">      <h4 class="text-center mb-3">Are you sure to confirm?</h4>      <h5 v-if="jsonData" class="text-center">        {{ jsonData.name }}      </h5>      <template #modal-footer>        <div class="w-100 d-flex justify-content-center mb-4">          <b-button            variant="secondary"            class="mr-3"            size="lg"            @click="confirmModalClose"          >            No          </b-button>          <b-button variant="danger" size="lg" @click="taskConfirm">            Yes          </b-button>        </div>      </template>    </b-modal>  </div></template><script>import TaskConfigurationCreate from '@/components/task_management/configurations/component/TaskConfigurationCreate';import TaskEdit from '@/components/task_management/task_list/edit/TaskEdit';import StageGroupTable from '@/components/task_management/task_detail/StageGroupTable';import Treeselect from '@riophae/vue-treeselect';import axios from 'axios';export default {  name: 'GeneralTab',  components: {    TaskEdit,    StageGroupTable,    TaskConfigurationCreate,    Treeselect,  },  props: {    taskDetail: {      type: Object,      default() {        return null;      },    },  },  watch: {    taskDetail: {      handler() {        this.loadData();      },      deep: true,    },  },  data() {    return {      name: null,      employee: null,      taskState: null,      state: null,      algorithm: null,      department: null,      code: null,      subFunctionId: null,      taskType: null,      createdEmployee: null,      updatedEmployee: null,      createdDate: null,      updatedDate: null,      confirmDate: null,      is_repeated: false,      taskConfirmPermission: false,      taskEditPermission: false,      jsonData: null,      messageText: null,      rotation: 0,      taskStageGroup: null,      taskTeams: null,      addingTaskTeamMember: null,      modalData: {        department: null,        date: null,        reason: null,        id: null,        index: null,      },      employees: [],      taskConfirmButtonDisabled: false,    };  },  mounted() {    this.loadData();  },  methods: {    confirmModalShow() {      this.$bvModal.show('task-confirm-modal');    },    confirmModalClose() {      this.$bvModal.hide('task-confirm-modal');    },    loadData() {      this.employee = this.taskDetail.executing_employee;      this.taskState = this.taskDetail.task_state;      this.state = this.taskDetail.state;      this.algorithm = this.taskDetail.algorithm;      this.department = this.taskDetail.department_id;      this.code = this.taskDetail.code;      this.subFunctionId = this.taskDetail.sub_function_id;      this.taskType = this.taskDetail.task_type;      // setting name      this.taskDetail.created_user;      const createdEmployee = parseInt(this.taskDetail.created_user);      const updatedEmployee = parseInt(this.taskDetail.updated_user);      for (const emp of this.$store.getters.company.employees) {        if (emp.partner__user__id === createdEmployee) {          this.createdEmployee = `${emp.partner__name} ${emp.partner__last_name}`;        }        if (emp.partner__user__id === updatedEmployee) {          this.updatedEmployee = `${emp.partner__name} ${emp.partner__last_name}`;        }      }      // formatting date      const date = new Date(this.taskDetail.created_date);      const day = date.toISOString().split('T')[0];      const time = date.toTimeString().split(' ')[0];      this.createdDate = `${day} ${time}`;      const dateUpdate = new Date(this.taskDetail.updated_date);      const dayUpdate = dateUpdate.toISOString().split('T')[0];      const timeUpdate = dateUpdate.toTimeString().split(' ')[0];      this.updatedDate = `${dayUpdate} ${timeUpdate}`;      if (this.taskDetail.confirm_date) {        const dateConfirm = new Date(this.taskDetail.confirm_date);        const dayConfirm = dateConfirm.toISOString().split('T')[0];        const timeConfirm = dateConfirm.toTimeString().split(' ')[0];        this.confirmDate = `${dayConfirm} ${timeConfirm}`;      }      // repeating task      this.is_repeated = this.taskDetail.is_repeated;      // setting task permission      if (this.taskState === 'draft' || this.taskState === 'sent') {        if (this.permission('task_hm1') || this.permission('task_hm2')) {          this.taskConfirmPermission = true;        }        const partnerId = this.$store.getters.user.partner_id;        let manager = 0;        for (const department of this.$store.getters.company.department) {          if (department.id === this.taskDetail.department_id.id) {            manager = department.manager__id;          }        }        const grantedUsers = [          this.taskDetail.created_employee,          this.taskDetail.executing_employee.id,          manager,        ];        if (grantedUsers.includes(partnerId)) {          this.taskEditPermission = true;        }        const createdUser = parseInt(this.taskDetail.created_user);        if (createdUser === this.$store.getters.user.id) {          this.taskEditPermission = true;        }      } else {        this.taskConfirmPermission = false;        this.taskEditPermission = false;      }      // checking json_data      this.jsonData = this.taskDetail.json_data;      // load task team      const params = this.taskDetail.id + '/?active=1';      this.getTaskTeamsByTaskId(params);      const employees = this.$store.getters.company.employees;      this.employees = [];      for (const i in employees) {        if (employees[i].is_active === '1') {          const jsonData = {};          jsonData.id = employees[i].partner__id;          jsonData.label =            employees[i].partner__name +            ' - ' +            employees[i].partner__last_name;          this.employees.push(jsonData);        }      }      // load stage group table      if (this.taskDetail.task_stage_groups) {        this.taskStageGroup = this.taskDetail.task_stage_groups;      }      if (this.jsonData) {        if (this.jsonData.task_stage_groups) {          this.taskStageGroup = this.jsonData.task_stage_groups;        }      }    },    changeTaskTeamMember(data) {      const employees = this.$store.getters.company.employees;      for (const i in employees) {        if (employees[i].partner__id === data.id) {          this.modalData.department = employees[i].department__id;        }      }    },    addTaskTeam() {      const params = {        active: '1',        created_date: new Date(),        created_user: this.$store.getters.user.id,        end_date: this.taskDetail.end_date,        start_date: this.taskDetail.start_date,        state: this.taskDetail.state,        task_id: this.taskDetail.id,        team_member: this.addingTaskTeamMember,        updated_date: new Date(),        updated_user: this.$store.getters.user.id,      };      this.postTaskTeamMember(params);      this.$refs['add-task-team-member'].hide();    },    async getTaskTeamsByTaskId(params) {      const response = await this.$store.dispatch(        'getTaskTeamsByTaskId',        params      );      if (response.status === 200) {        this.taskTeams = response.data.results;      }    },    async postTaskTeamMember(params) {      const response = await this.$store.dispatch('postTaskTeamMember', params);      if (response.status === 200) {        const params = this.taskDetail.id + '/?active=1';        this.getTaskTeamsByTaskId(params);      }    },    taskConfirm() {      this.taskConfirmButtonDisabled = true;      this.$bvModal.hide('task-confirm-modal');      const taskId = this.taskDetail.id;      const url = `pages/plan/task_update/${taskId}/`;      let executingEmployee;      if (this.taskDetail.executing_employee) {        executingEmployee = this.taskDetail.executing_employee.id;      } else {        executingEmployee = null;      }      let departmentId;      if (this.taskDetail.department_id) {        departmentId = this.taskDetail.department_id.id;      } else {        departmentId = null;      }      let algorithm;      if (this.taskDetail.algorithm) {        algorithm = this.taskDetail.algorithm.id;      } else {        algorithm = null;      }      let initiator;      if (this.taskDetail.initiator) {        initiator = this.taskDetail.initiator.id;      } else {        initiator = null;      }      let subFunction;      if (this.taskDetail.sub_function_id) {        subFunction = this.taskDetail.sub_function_id.id;      } else {        subFunction = null;      }      let taskType;      if (this.taskDetail.task_type) {        taskType = this.taskDetail.task_type;      } else {        taskType = this.taskDetail.json_data.task_type;      }      const jsonData = this.taskDetail.json_data;      const payload = {        id: taskId,        planned_start_date: this.taskDetail.start_date,        start_date: this.taskDetail.start_date,        planned_end_date: this.taskDetail.end_date,        end_date: this.taskDetail.end_date,        executing_employee: executingEmployee,        organization: this.taskDetail.organization,        department_id: departmentId,        algorithm,        initiator,        sub_function_id: subFunction,        name: this.taskDetail.name,        code: this.taskDetail.code,        updated_user: this.$store.getters.user.id,        task_type: taskType,        task_state: 'confirm',        task_stage_groups: jsonData.task_stage_groups,        task_team: jsonData.task_team,      };      this.messageText = 'Task confirmed.';      axios        .post(url, payload)        .then(() => {          this.taskConfirmButtonDisabled = false;          alert('Task confirmed.');          window.location.reload();        })        .catch(() => {          alert('An error occured.');          this.taskConfirmButtonDisabled = false;        });    },    taskEdit() {      this.$root.$emit('bv::toggle::collapse', 'task-edit');    },    show() {      this.$bvModal.show('message-box');    },    detailCollapse() {      if (this.rotation === 0) {        this.rotation = 180;      } else {        this.rotation = 0;      }    },  },};</script>