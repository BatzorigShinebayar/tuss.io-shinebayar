<template>  <div class="mt-4 pb-5">    <b-table      striped      :hover="true"      :items="tableData"      :fields="tableField"      :responsive="true"      class="mb-5"    >      <template #cell(process)="data">        <b-progress          class="stage-progress"          :max="data.item.process.total"          show-value          style="width: 150px"        >          <b-progress-bar            :value="data.item.process.complete"            variant="success"          ></b-progress-bar>          <b-progress-bar            :value="data.item.process.on_process"            variant="warning"          ></b-progress-bar>          <b-progress-bar            :value="data.item.process.on_queue"            variant="danger"          ></b-progress-bar>        </b-progress>      </template>      <template #cell(action)="row">        <b-button          variant="deep-blue"          size="sm"          @click="performTask(row)"          v-if="use_perform_task"        >          Perform&nbsp;task        </b-button>      </template>      <template #cell(detail)="row">        <Fa          v-if="row.detailsShowing"          :icon="['fas', 'caret-circle-up']"          size="2x"          @click="row.toggleDetails"          class="cursor-pointer"          :class="            row.item.state === 'complete' ? 'text-success' : 'text-deep-blue'          "        />        <Fa          v-else          :icon="['fas', 'caret-circle-down']"          size="2x"          @click="row.toggleDetails"          class="cursor-pointer"          :class="            row.item.state === 'complete' ? 'text-success' : 'text-deep-blue'          "        />      </template>      <template #row-details="row">        <h5 v-if="row.item.task_stages.length === 0">No stages to show</h5>        <div class="mr-4 ml-4">          <table class="w-100 mb-4">            <tr v-for="stage of row.item.task_stages" :key="stage.id">              <td :style="{ width: '40px' }">{{ stage.code }}</td>              <td>{{ stage.name }}</td>              <td>                <b-badge v-if="stage.state === 'on_queue'" variant="danger"                  >On queue                </b-badge>                <b-badge                  v-else-if="stage.state === 'on_process'"                  variant="warning"                  >On process                </b-badge>                <b-badge                  v-else-if="stage.state === 'complete'"                  variant="success"                  >Complete                </b-badge>              </td>            </tr>          </table>        </div>      </template>    </b-table>  </div></template><script>export default {  name: 'StageGroupTable',  props: {    stage: {      type: [Object, Array],      default() {        return [];      },    },    algorithm: {      type: [Object, Array],      default() {        return [];      },    },    use_perform_task: {      type: Boolean,      default() {        return false;      },    },  },  data() {    return {      tableData: null,      tableField: [        {          key: 'code',          label: 'Code',          thClass: 'tdalgcode',        },        {          key: 'name',          label: 'Name',        },        {          key: 'employee',          label: 'Executor',          sortable: true,          thClass: 'tdprogress',        },        {          key: 'start_date',          label: 'Start date',          sortable: true,          thClass: 'tddate',        },        {          key: 'end_date',          label: 'End date',          sortable: true,          thClass: 'tddate',        },        {          key: 'process',          label: 'Process',          sortable: true,          thClass: 'tdprogress',        },        {          key: 'action',          label: 'Action',          thClass: 'tdaction',        },        {          key: 'detail',          label: '',          thClass: 'tddetail',        },      ],      tableFieldSelected: [],    };  },  watch: {    stage() {      this.loadData();    },  },  mounted() {    this.loadData();  },  methods: {    loadData() {      const tableData = this.stage;      const rows = [];      let taskAlgorithm;      if (tableData) {        for (const alg of this.$store.getters.company.algorithm) {          if (alg.id === this.algorithm.id) {            taskAlgorithm = alg;          }        }        for (const tableRow of tableData) {          //setting progress bar          let totalStage = 0;          let complete = 0;          let on_queue = 0;          let on_process = 0;          if (tableRow.task_stages) {            totalStage = tableRow.task_stages.length;            for (const sgt of tableRow.task_stages) {              if (sgt.state === 'complete') {                complete += 1;              }              if (sgt.state === 'on_queue') {                on_queue += 1;              }              if (sgt.state === 'on_process') {                on_process += 1;              }            }          }          //setting employee          let employee;          for (const emp of this.$store.getters.company.employees) {            if (tableRow.employee) {              if (emp.partner__id === tableRow.employee) {                employee = `${emp.partner__name} ${emp.partner__last_name}`;              }            }          }          //setting stage group id          let stageGroupId;          if (tableRow.stage_group.id) {            stageGroupId = tableRow.stage_group.id;          } else {            stageGroupId = tableRow.stage_group;          }          //setting stage group name          let stageCode = null;          let stageName = null;          for (const sg of taskAlgorithm.stage_groups) {            if (stageGroupId === sg.id) {              stageCode = sg.code;              stageName = sg.name;              break;            }          }          //setting task stages          let taskStages = [];          for (const stage of tableRow.task_stages) {            for (const stage_groups of taskAlgorithm.stage_groups) {              for (const stg of stage_groups.stages) {                let realStageId;                if (stage.stage.id) {                  realStageId = stage.stage.id;                } else {                  realStageId = stage.stage;                }                if (realStageId === stg.id) {                  taskStages.push({                    id: stg.id,                    code: stg.code,                    name: stg.name,                    state: stage.state,                  });                  break;                }              }            }          }          let formId = null;          if (tableRow.form) {            formId = tableRow.form;          } else {            for (const sta of taskAlgorithm.stage_groups) {              if (sta.id === tableRow.stage_group.id) {                formId = sta.form;              }            }          }          rows.push({            id: tableRow.id,            code: stageCode,            name: stageName,            employee,            start_date: tableRow.start_date,            end_date: tableRow.end_date,            state: tableRow.state,            process: {              total: totalStage,              complete,              on_process,              on_queue,            },            task_stages: taskStages,            entry: tableRow.entry,            form: formId,          });        }        this.tableData = rows;      }    },    performTask(stageGroup) {      let routeData = null;      if (stageGroup.item.entry) {        routeData = this.$router.resolve({          name: 'form-edit',          query: {            id: stageGroup.item.form,            did: stageGroup.item.entry,            tsk: this.$route.query.id,            tsg: stageGroup.item.id,          },        });      } else {        routeData = this.$router.resolve({          name: 'form-entry',          query: {            id: stageGroup.item.form,            tal: this.algorithm.id,            tsk: this.$route.query.id,            tsg: stageGroup.item.id,          },        });      }      window.open(routeData.href, '_blank');    },  },};</script>