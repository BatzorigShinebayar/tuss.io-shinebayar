<template>  <div>    <a class="mr-3 p-1 cursor-pointer" @click="showFilter">      <Fa :icon="['fas', 'filter']" class="mr-1" />Filter    </a>    <b-modal id="task-detail-filter" scrollable @hidden="hideFilter">      <template #modal-header="{ close }">        <p><Fa :icon="['fas', 'filter']" /> Filter</p>        <button type="button" aria-label="Close" class="close" @click="close()">          Ã—        </button>      </template>      <div class="p-2">        <b-form-group label="Task name" label-for="task-filter-name">          <b-form-input id="task-filter-name" v-model="taskName"></b-form-input>        </b-form-group>        <b-form-group label="Task type" label-for="task-filter-type">          <treeselect            id="task-filter-type"            v-model="taskType"            :multiple="false"            :options="taskTypeList"            :normalizer="taskTypeNormalizer"          />        </b-form-group>        <b-form-group label="Function" label-for="selector-function">          <treeselect            id="selector-function"            v-model="taskFunction"            :multiple="false"            :clearable="true"            :disable-branch-nodes="true"            :options="taskFunctionList"            :normalizer="taskFunctionNormalizer"          >            <label slot="option-label" slot-scope="{ node }">              <strong>{{ node.raw.code }}</strong> {{ node.raw.name }}            </label>            <div slot="value-label" slot-scope="{ node }">              <strong>{{ node.raw.code }}</strong> {{ node.raw.name }}            </div>          </treeselect>        </b-form-group>        <b-form-group label="Department" label-for="selector-department">          <treeselect            id="selector-department"            v-model="taskDepartment"            :multiple="false"            :options="taskDepartmentList"            :normalizer="taskDepartmentNormalizer"          />        </b-form-group>        <b-form-group label="Algorithm" label-for="selector-algorithm">          <treeselect            id="selector-algorithm"            v-model="taskAlgorithm"            :multiple="false"            :options="taskAlgorithmList"            :normalizer="taskAlgorithmNormalizer"          />        </b-form-group>        <b-form-group label="Task state" label-for="selector-state">          <treeselect            id="selector-state"            v-model="taskState"            :multiple="false"            :options="taskStateList"          />        </b-form-group>        <b-form-group          label-cols="4"          label-cols-lg="3"          label="Start date"          label-for="task-filter-type-start-date"        >          <b-form-datepicker            id="task-filter-type-start-date"            v-model="taskStartDate"          ></b-form-datepicker>        </b-form-group>        <b-form-group          label-cols="4"          label-cols-lg="3"          label="End date"          label-for="task-filter-type-end-date"        >          <b-form-datepicker            id="task-filter-type-end-date"            v-model="taskEndDate"          ></b-form-datepicker>        </b-form-group>        <b-form-group          class="mb-4"          label="Task Executor"          label-for="selector-employee"        >          <treeselect            id="selector-employee"            v-model="taskEmployees"            :multiple="true"            :value-consists-of="'LEAF_PRIORITY'"            :options="taskEmployeesList"          >          </treeselect>        </b-form-group>      </div>      <template #modal-footer>        <div class="w-100">          <b-button            variant="primary"            class="ml-2 float-right"            @click="searchTask"          >            Filter          </b-button>          <b-button variant="light" class="float-right" @click="hideModal">            Cancel          </b-button>        </div>      </template>    </b-modal>  </div></template><script>import Treeselect from '@riophae/vue-treeselect';export default {  name: 'TaskDetailFilter',  components: {    Treeselect,  },  data() {    return {      taskName: null,      taskType: null,      taskFunction: null,      taskDepartment: null,      taskAlgorithm: null,      taskState: null,      taskStartDate: null,      taskEndDate: null,      taskEmployees: null,      taskTypeNormalizer(node) {        return {          id: node.id,          label: node.code + ' | ' + node.name,        };      },      taskFunctionNormalizer(node) {        let nodeId;        if (node.sub_function) {          nodeId = 'p' + node.id;        } else {          nodeId = node.id;        }        return {          id: nodeId,          label: node.name,          children: node.sub_function,        };      },      taskDepartmentNormalizer(node) {        return {          id: node.id,          label: node.short_name + ' | ' + node.name,        };      },      taskAlgorithmNormalizer(node) {        return {          id: node.id,          label: node.name,        };      },      taskStateList: [        { id: 'draft', label: 'Draft' },        { id: 'sent', label: 'Sent' },        { id: 'confirm', label: 'Confirm' },        { id: 'finish', label: 'Finish' },      ],    };  },  computed: {    taskTypeList() {      const optionList = [];      const allTaskTypes = this.$store.getters.company.task_type;      for (const taskType of allTaskTypes) {        if (taskType.active === '1') {          optionList.push(taskType);        }      }      return optionList;    },    taskFunctionList() {      const optionList = [];      for (const funct of this.$store.getters.company.function) {        if (funct.is_active === '1') {          optionList.push(funct);        }      }      return optionList;    },    taskDepartmentList() {      const optionList = [];      const allDepartment = this.$store.getters.company.department;      for (const department of allDepartment) {        if (department.is_active === '1') {          optionList.push(department);        }      }      return optionList;    },    taskAlgorithmList() {      const optionList = [];      const allAlgorithm = this.$store.getters.company.algorithm;      for (const department of allAlgorithm) {        if (department.is_active === '1') {          optionList.push(department);        }      }      return optionList;    },    taskEmployeesList() {      const employeeList = this.$store.getters.company.employees;      const allDepartments = this.$store.getters.company.department;      const activeDepartments = [];      for (const department of allDepartments) {        if (department.is_active === '1') {          const employees = [];          for (const emp of employeeList) {            if (emp.department__id === department.id) {              if (emp.is_active === '1') {                const employeeContext = {                  id: emp.partner__id,                  label: emp.partner__name + ' ' + emp.partner__last_name,                };                employees.push(employeeContext);              }            }          }          const departmentContext = {            id: department.id + 'dep',            label: department.name,            children: employees,          };          activeDepartments.push(departmentContext);        }      }      return activeDepartments;    },  },  methods: {    showFilter() {      this.taskName = this.$route.query.search;      this.taskType = this.$route.query.task_type;      this.taskFunction = this.$route.query.sub_function_id;      this.taskDepartment = this.$route.query.department_id;      this.taskAlgorithm = this.$route.query.algorithm;      this.taskState = this.$route.query.task_state;      this.taskStartDate = this.$route.query.start_date;      this.taskEndDate = this.$route.query.end_date;      const employees = this.$route.query.executing_employee;      if (employees) {        this.taskEmployees = employees.split(',').map((emp) => parseInt(emp));      }      this.$root.$emit('bv::show::modal', 'task-detail-filter');    },    hideFilter() {      this.taskName = null;      this.taskType = null;      this.taskFunction = null;      this.taskDepartment = null;      this.taskAlgorithm = null;      this.taskState = null;      this.taskEmployees = null;      this.taskStartDate = null;      this.taskEndDate = null;    },    hideModal() {      this.$root.$emit('bv::hide::modal', 'task-detail-filter');    },    async searchTask() {      this.hideModal();      const query = {};      if (this.taskName) {        query.search = this.taskName;      }      if (this.taskType) {        query.task_type = this.taskType;      }      if (this.taskFunction) {        query.sub_function_id = this.taskFunction;      }      if (this.taskDepartment) {        query.department_id = this.taskDepartment;      }      if (this.taskAlgorithm) {        query.algorithm = this.taskAlgorithm;      }      if (this.taskState) {        query.task_state = this.taskState;      }      if (this.taskStartDate) {        query.start_date = this.taskStartDate;      }      if (this.taskEndDate) {        query.end_date = this.taskEndDate;      }      if (this.taskEmployees) {        query.executing_employee = this.taskEmployees.join();      }      await this.$router.replace({ query });      this.$emit('reload', true);    },  },};</script>